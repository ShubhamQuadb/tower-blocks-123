<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1, user-scalable=no" />
    <meta name="theme-color" content="#000000" />
    <title>Pacman - Android</title>
    
    <!-- App Icons -->
    <link rel="icon" type="image/png" sizes="32x32" href="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMzIiIGhlaWdodD0iMzIiIHZpZXdCb3g9IjAgMCAzMiAzMiIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHJlY3Qgd2lkdGg9IjMyIiBoZWlnaHQ9IjMyIiBmaWxsPSIjMDAwMDAwIi8+CjxjaXJjbGUgY3g9IjE2IiBjeT0iMTYiIHI9IjEyIiBmaWxsPSIjRkZGRjAwIi8+CjxjaXJjbGUgY3g9IjE2IiBjeT0iMTIiIHI9IjIiIGZpbGw9IiMwMDAwMDAiLz4KPHBhdGggZD0iTTE2IDE2IEwyNCA4IEwxNiAxNiBMMTYgMjQiIGZpbGw9IiMwMDAwMDAiLz4KPC9zdmc+">
    <link rel="icon" type="image/png" sizes="16x16" href="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTYiIGhlaWdodD0iMTYiIHZpZXdCb3g9IjAgMCAxNiAxNiIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHJlY3Qgd2lkdGg9IjE2IiBoZWlnaHQ9IjE2IiBmaWxsPSIjMDAwMDAwIi8+CjxjaXJjbGUgY3g9IjgiIGN5PSI4IiByPSI2IiBmaWxsPSIjRkZGRjAwIi8+CjxjaXJjbGUgY3g9IjgiIGN5PSI2IiByPSIxIiBmaWxsPSIjMDAwMDAwIi8+CjxwYXRoIGQ9Ik04IDggTDEyIDQgTDggOCBMOCAxMiIgZmlsbD0iIzAwMDAwMCIvPgo8L3N2Zz4=">
    <link rel="apple-touch-icon" sizes="180x180" href="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTgwIiBoZWlnaHQ9IjE4MCIgdmlld0JveD0iMCAwIDE4MCAxODAiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+CjxyZWN0IHdpZHRoPSIxODAiIGhlaWdodD0iMTgwIiBmaWxsPSIjMDAwMDAwIi8+CjxjaXJjbGUgY3g9IjkwIiBjeT0iOTAiIHI9IjcwIiBmaWxsPSIjRkZGRjAwIi8+CjxjaXJjbGUgY3g9IjkwIiBjeT0iNjAiIHI9IjEwIiBmaWxsPSIjMDAwMDAwIi8+CjxwYXRoIGQ9Ik05MCA5MCBMMTQwIDQwIEw5MCA5MCBMOTAgMTQwIiBmaWxsPSIjMDAwMDAwIi8+Cjwvc3ZnPg==">
    <link rel="shortcut icon" href="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMzIiIGhlaWdodD0iMzIiIHZpZXdCb3g9IjAgMCAzMiAzMiIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHJlY3Qgd2lkdGg9IjMyIiBoZWlnaHQ9IjMyIiBmaWxsPSIjMDAwMDAwIi8+CjxjaXJjbGUgY3g9IjE2IiBjeT0iMTYiIHI9IjEyIiBmaWxsPSIjRkZGRjAwIi8+CjxjaXJjbGUgY3g9IjE2IiBjeT0iMTIiIHI9IjIiIGZpbGw9IiMwMDAwMDAiLz4KPHBhdGggZD0iTTE2IDE2IEwyNCA4IEwxNiAxNiBMMTYgMjQiIGZpbGw9IiMwMDAwMDAiLz4KPC9zdmc+">
    
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Permanent+Marker" />
    <link rel="stylesheet" href="style.css" />
  </head>
  <body>
    <!-- Splash Screen -->
    <div id="splash" style="position:fixed;inset:0;background:#000;display:flex;align-items:center;justify-content:center;flex-direction:column;z-index:1000;color:#0ff;font-family:'Permanent Marker', cursive;">
      <div style="font-size:28px;margin-bottom:8px;">PACMAN</div>
      <div id="eat-row" style="display:flex;align-items:center;gap:12px;margin:6px 0;">
        <svg id="pacSvg" width="44" height="44" viewBox="0 0 40 40" aria-label="Pacman icon">
          <circle cx="20" cy="20" r="18" fill="#ffeb3b"></circle>
          <circle cx="24" cy="14" r="3" fill="#000"></circle>
          <polygon id="mouth" points="20,20 40,10 40,30" fill="#000"></polygon>
        </svg>
        <span class="dot" style="color:#6ff;font-size:18px;">‚óè</span>
        <span class="dot" style="color:#6ff;font-size:18px;">‚óè</span>
        <span class="dot" style="color:#6ff;font-size:18px;">‚óè</span>
        <span class="dot" style="color:#6ff;font-size:18px;">‚óè</span>
        <span class="dot" style="color:#6ff;font-size:18px;">‚óè</span>
      </div>
      <div style="font-size:14px;color:#9ff">Loading‚Ä¶</div>
    </div>

    <!-- Home Screen (shown before game start) -->
    <div id="home" style="position:fixed;inset:0;display:none;align-items:center;justify-content:center;z-index:900;overflow:hidden;">
      <!-- Modern banner background (behind card) -->
      <div aria-hidden="true" style="position:absolute;inset:0;background:url('./wp13214700-pacman-iphone-wallpapers.jpg') center/cover no-repeat;
      "></div>
      <!-- Accent shapes -->
      <div aria-hidden="true" style="position:absolute;top:-60px;left:-60px;width:240px;height:240px;border-radius:50%;background:linear-gradient(145deg,#00ffa3,#00ccff);filter:blur(20px);opacity:.25"></div>
      <div aria-hidden="true" style="position:absolute;bottom:-70px;right:-50px;width:280px;height:280px;border-radius:50%;background:linear-gradient(145deg,#00ccff,#7c3aed);filter:blur(24px);opacity:.22"></div>
      <!-- 3D banner scene: Pacman and enemies -->
      <style>
        /* Inline styles limited to the home scene */
        #home .scene{position:absolute;inset:0;display:block;pointer-events:none;perspective:1000px}
        #home .stage{position:absolute;left:50%;top:36%;width:92%;max-width:760px;height:190px;transform:translateX(-50%) rotateX(6deg) rotateY(-5deg);transform-style:preserve-3d;filter:drop-shadow(0 14px 26px rgba(0,0,0,.4))}
        #home .track{position:absolute;left:0;right:0;top:55%;height:5px;margin-top:-2.5px;background:linear-gradient(90deg,rgba(255,255,255,.3) 0 14px,rgba(255,255,255,0) 14px 30px);transform:translateZ(-50px)}
        #home .pac{position:absolute;left:110px;top:55%;width:68px;height:68px;border-radius:50%;background:radial-gradient(circle at 30% 30%,#fff176 0%,#ffca28 50%,#f5a623 100%);outline:3px solid rgba(255,255,255,.2);transform:translateY(-50%) translateZ(28px)}
        #home .pac:before{content:"";position:absolute;left:34px;top:14px;width:9px;height:9px;border-radius:50%;background:#0b1020;box-shadow:0 0 0 2px rgba(255,255,255,.2) inset}
        #home .pac .mouth{position:absolute;left:32px;top:34px;width:40px;height:40px;background:conic-gradient(#0b0f1a 0 60deg,transparent 60deg 300deg,#0b0f1a 300deg);border-radius:0 50% 50% 50%;transform:translate(-50%,-50%)}
        #home .dot{position:absolute;top:55%;width:12px;height:12px;border-radius:50%;background:rgba(255,255,255,.95);box-shadow:0 0 10px rgba(255,255,255,.6);transform:translateY(-50%) translateZ(6px)}
        #home .d1{left:180px}#home .d2{left:240px}#home .d3{left:300px}#home .d4{left:360px}#home .d5{left:420px}
        #home .ghost{position:absolute;top:55%;width:58px;height:64px;border-radius:28px 28px 12px 12px;background:radial-gradient(circle at 30% 20%,rgba(255,255,255,.28) 0 24%,transparent 26%),var(--gcol);
          transform:translateY(-50%) translateZ(22px);box-shadow:0 12px 22px rgba(0,0,0,.3);outline:3px solid rgba(255,255,255,.18)}
        #home .ghost:before,#home .ghost:after{content:"";position:absolute;top:18px;width:14px;height:14px;border-radius:50%;background:#fff}
        #home .ghost:before{left:12px}#home .ghost:after{left:31px}
        #home .ghost .pupil{position:absolute;top:24px;left:18px;width:9px;height:9px;border-radius:50%;background:#08243f}
        #home .g1{--gcol:#22d3ee;left:500px}
        #home .g2{--gcol:#f472b6;left:570px}
        #home .g3{--gcol:#fb7185;left:640px}
      </style>
      
      <div class="scene" aria-hidden="true">
        <div class="stage">
          <div class="track"></div>
          <div class="pac"><div class="mouth"></div></div>
          <div class="dot d1"></div>
          <div class="dot d2"></div>
          <div class="dot d3"></div>
          <div class="dot d4"></div>
          <div class="dot d5"></div>
          <div class="ghost g1"><div class="pupil"></div></div>
          <div class="ghost g2"><div class="pupil"></div></div>
          <div class="ghost g3"><div class="pupil"></div></div>
        </div>
      </div>
      <!-- Content card (above banner) -->
      <div style="position:relative;z-index:2;width:92%;max-width:520px;border-radius:14px;background:rgba(6,12,20,.78);backdrop-filter:blur(6px);padding:16px;border:1px solid rgba(0,204,255,.25);box-shadow:0 12px 40px rgba(0,0,0,.35);text-align:center;color:#eafffb;">
        <div style="font-family:'Permanent Marker', cursive;font-size:26px;letter-spacing:1px;color:#35f7c6;margin-bottom:6px;">Pacman</div>
        <div style="font-size:12px;color:#bfe8ff;opacity:.95;margin-bottom:14px;">Modern Smartphone Edition</div>
        <button id="btnStartGame" style="width:100%;padding:12px 10px;margin:6px 0;background:linear-gradient(90deg,#00ffaa,#00ccff);border:none;border-radius:10px;color:#001;font-weight:700;letter-spacing:.5px;box-shadow:0 6px 16px rgba(0,204,255,.35);">START GAME</button>
        <button id="btnHelp" style="width:100%;padding:10px;margin:6px 0;background:rgba(13,34,48,.9);border:1px solid rgba(0,170,255,.45);border-radius:10px;color:#bfe8ff;">HELP</button>
      </div>
    </div>

    <!-- Help Modal -->
    <div id="helpModal" style="position:fixed;inset:0;background:rgba(0,0,0,.75);display:none;align-items:center;justify-content:center;z-index:950;">
      <div style="width:92%;max-width:560px;background:#0b1116;border:1px solid #0aa;border-radius:10px;color:#d9f7ff;padding:14px;">
        <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:8px;">
          <div style="font-weight:700;color:#6df;">How to Play</div>
          <button id="btnCloseHelp" style="background:#07202c;color:#9ad;border:1px solid #0aa;border-radius:6px;padding:6px 10px;">Close</button>
        </div>
        <ul style="margin:0;padding-left:18px;line-height:1.6;color:#bfe8ff;text-align:left;">
          <li>Use the on-screen arrows to move Pac-Man.</li>
          <li>Eat all dots to clear the level.</li>
          <li>Power pills make ghosts vulnerable for a short time.</li>
          <li>Tap the Start/Pause/Resume button to start, pause, or resume the game.</li>
          <li>Use the Sound button to toggle audio on/off.</li>
          <li><strong>Lives:</strong> The game starts with 2 lives. After 2 game overs, the game will restart automatically.</li>
        </ul>
      </div>
    </div>
    <div id="shim">shim for font face</div>
    <h1>üéÆ Pacman - Android</h1>
    <p id="instructions">
      Tap the arrow buttons to move Pac-Man and eat all dots
    </p>

    <!-- Game Wrapper (hidden initially, shown when game starts) -->
    <div class="game-wrapper" style="display:none;">
      <div id="pacman" aria-label="Pacman Canvas Wrapper"></div>
    </div>

    <!-- Mobile Controls -->
    <div class="controls" aria-label="Mobile Controls">
      <!-- Top row: Sound and Start/Pause/Resume button -->
      <div class="controls-row controls-top">
        <button class="pill-btn sound-btn" data-key="83" aria-label="Toggle Sound (S)">üîä Sound</button>
        <button class="pill-btn btn-start-pause" data-key="78" aria-label="Start/Pause/Resume">‚ñ∂ Start</button>
      </div>
      <!-- Bottom row: Arrow buttons -->
      <div class="controls-row">
        <button class="ctrl-btn btn-up" data-key="38" aria-label="Up">‚ñ≤</button>
      </div>
      <div class="controls-row">
        <button class="ctrl-btn btn-left" data-key="37" aria-label="Left">‚óÄ</button>
        <button class="ctrl-btn btn-down" data-key="40" aria-label="Down">‚ñº</button>
        <button class="ctrl-btn btn-right" data-key="39" aria-label="Right">‚ñ∂</button>
      </div>
    </div>

    <script src="jiogames_sp_wrapper.js" type="text/javascript"></script>
    <script>
        // Console logging for smartphone SDK
        console.log("Pacman - Smartphone SDK initialized");
        
        // Hide controls immediately when page loads (during splash)
        (function() {
          var controls = document.querySelector('.controls');
          if (controls) {
            controls.style.display = 'none';
            controls.style.visibility = 'hidden';
            controls.style.opacity = '0';
            controls.style.pointerEvents = 'none';
            console.log("Pacman: Controls hidden during splash");
          }
        })();
        
        window.addEventListener('load', function() {
            console.log("Pacman Smartphone - Page Loaded");
            // Note: cacheAd() will be called ONLY at game start (in startNewGame())
            // NOT during initialization per JioGames guidelines
            
            // Hide splash immediately after load, then show home (no glitch)
          setTimeout(function(){
            var s=document.getElementById('splash'); 
            if(s){ 
              s.style.display='none'; 
              console.log("Pacman: Splash hidden");
            }
            var h=document.getElementById('home'); 
            if(h){ 
              h.style.display='flex'; 
              document.body.classList.add('home-visible');
              console.log("Pacman: Home shown, controls should stay hidden");
            }
          }, 300);
            
            // Load banner immediately on page load (like Space Battle)
            try{
                        loadBanner();
                        console.log("Pacman: Banner loading started");
                        // Show banner after it loads
                        setTimeout(function(){ 
                                showBanner(); 
                    setBottomBanner(); 
                        }, 1000);
                } catch(e) { console.log(e); }
            
            // Note: cacheAd() will be called ONLY at game start (in startNewGame())
            // NOT during initialization per JioGames guidelines
        });
    </script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/2.1.3/jquery.min.js" type="text/javascript"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/modernizr/2.8.3/modernizr.min.js" type="text/javascript"></script>
    <script src="./app.js" type="text/javascript"></script>

    <!-- Touch/Click Controls Script -->
    <script>
      (function() {
        function fireKey(code) {
          try {
            const ev = new KeyboardEvent('keydown', {bubbles: true, cancelable: true, keyCode: code, which: code});
            Object.defineProperty(ev, 'keyCode', {get: function(){return code;}});
            Object.defineProperty(ev, 'which', {get: function(){return code;}});
            document.dispatchEvent(ev);
          } catch (e) {
            // Fallback for older browsers
            const ev = document.createEvent('Event');
            ev.initEvent('keydown', true, true);
            ev.keyCode = code;
            ev.which = code;
            document.dispatchEvent(ev);
          }
        }

        // handle tap & press-and-hold to repeat
        let repeatTimer = null;
        const REPEAT_MS = 120; // Faster response for smartphones

        function startRepeat(code) {
          fireKey(code);
          clearInterval(repeatTimer);
          repeatTimer = setInterval(function(){ fireKey(code); }, REPEAT_MS);
        }
        function stopRepeat() {
          clearInterval(repeatTimer);
          repeatTimer = null;
        }

        function bindBtn(btn) {
          const code = parseInt(btn.getAttribute('data-key'), 10);
          var touchHandled = false;
          
          // Touch (better for Android) - handle first
          btn.addEventListener('touchstart', function(e){ 
            e.preventDefault();
            touchHandled = true;
            startRepeat(code);
            // Haptic feedback for Android
            if (navigator.vibrate) {
              navigator.vibrate(10);
            }
          }, {passive:false});
          
          btn.addEventListener('touchend', function(e){ 
            e.preventDefault(); 
            stopRepeat();
            // Reset flag after delay to prevent mouse event
            setTimeout(function() {
              touchHandled = false;
            }, 300);
          }, {passive:false});
          
          btn.addEventListener('touchcancel', function() {
            stopRepeat();
            setTimeout(function() {
              touchHandled = false;
            }, 300);
          }, {passive:true});
          
          // Mouse (only if touch wasn't handled)
          btn.addEventListener('mousedown', function(e){
            if (!touchHandled) {
              startRepeat(code);
            }
          });
          btn.addEventListener('mouseup', function(e) {
            if (!touchHandled) {
              stopRepeat();
            }
          });
          btn.addEventListener('mouseleave', function(e) {
            if (!touchHandled) {
              stopRepeat();
            }
          });
          btn.addEventListener('click', function(e){ 
            e.preventDefault();
          });
        }

        document.addEventListener('DOMContentLoaded', function(){
          // Bind buttons except start-pause button (which has custom handler)
          document.querySelectorAll('.ctrl-btn, .pill-btn:not(.btn-start-pause)').forEach(bindBtn);
          // Splash Pacman eating animation
          (function(){
            var mouth = document.getElementById('mouth');
            var dots = Array.prototype.slice.call(document.querySelectorAll('#eat-row .dot'));
            var open = true, i = 0;
            setInterval(function(){
              // toggle mouth shape
              if (mouth) {
                mouth.setAttribute('points', open ? '20,20 40,19 40,21' : '20,20 40,10 40,30');
                open = !open;
              }
              // eat a dot every other toggle
              if (!open && dots.length) {
                if (i < dots.length) {
                  dots[i].style.opacity = '0';
                  i++;
                } else {
                  // reset
                  dots.forEach(function(d){ d.style.opacity = '1'; });
                  i = 0;
                }
              }
            }, 200);
          })();
          // Home screen bindings
          var hs=document.getElementById('home');
          var btnStart=document.getElementById('btnStartGame');
          var btnHelp=document.getElementById('btnHelp');
          var help=document.getElementById('helpModal');
          var btnClose=document.getElementById('btnCloseHelp');
          function fireKey(code){
            try{
              console.log('Pacman: fireKey called with code:', code);
              
              // Try modern approach first
              var ev = null;
              try {
                // Modern browsers - create event with initKeyboardEvent or KeyboardEvent
                if (typeof KeyboardEvent !== 'undefined') {
                  ev = new KeyboardEvent('keydown', {
                    bubbles: true,
                    cancelable: true,
                    view: window
                  });
                  
                  // Set keyCode and which using defineProperty for compatibility
                  Object.defineProperty(ev, 'keyCode', {
                    get: function() { return code; },
                    enumerable: true,
                    configurable: true
                  });
                  Object.defineProperty(ev, 'which', {
                    get: function() { return code; },
                    enumerable: true,
                    configurable: true
                  });
                  Object.defineProperty(ev, 'charCode', {
                    get: function() { return 0; },
                    enumerable: true,
                    configurable: true
                  });
                  
                  // Also try setting directly (some browsers allow this)
                  try {
                    ev.keyCode = code;
                    ev.which = code;
                  } catch(e) {
                    // Ignore if not settable
                  }
                }
              } catch(e) {
                console.log('Pacman: Modern KeyboardEvent failed, using fallback');
              }
              
              // Fallback for older browsers
              if (!ev) {
                try {
                  ev = document.createEvent('KeyboardEvent');
                  ev.initKeyboardEvent('keydown', true, true, window, false, false, false, false, 0, code);
                } catch(e) {
                  // Final fallback - use generic event
                  ev = document.createEvent('Event');
                  ev.initEvent('keydown', true, true);
                  ev.keyCode = code;
                  ev.which = code;
                }
              }
              
              // Ensure keyCode is set
              if (ev.keyCode !== code) {
                try {
                  Object.defineProperty(ev, 'keyCode', {
                    get: function() { return code; },
                    enumerable: true,
                    configurable: true
                  });
                  Object.defineProperty(ev, 'which', {
                    get: function() { return code; },
                    enumerable: true,
                    configurable: true
                  });
                } catch(e) {
                  // If defineProperty fails, try direct assignment
                  ev.keyCode = code;
                  ev.which = code;
                }
              }
              
              console.log('Pacman: Dispatching keydown event, keyCode:', ev.keyCode || code, 'which:', ev.which || code);
              
              // Dispatch to document - app.js listens with capture phase (true)
              var result = document.dispatchEvent(ev);
              console.log('Pacman: Event dispatched successfully, defaultPrevented:', ev.defaultPrevented, 'result:', result);
              
              // Also try dispatching directly to window as fallback
              if (!result) {
                console.log('Pacman: Trying window.dispatchEvent as fallback');
                window.dispatchEvent(ev);
              }
              
            }catch(e){
              console.error('Pacman: Error in fireKey:', e, e.stack);
              // Last resort - try to call the keyDown function directly if accessible
              try {
                if (window.PACMAN && typeof window.PACMAN.keyDown === 'function') {
                  console.log('Pacman: Attempting direct keyDown call');
                  var fakeEvent = { keyCode: code, which: code, preventDefault: function(){}, stopPropagation: function(){} };
                  window.PACMAN.keyDown(fakeEvent);
                }
              } catch(e2) {
                console.error('Pacman: Direct call also failed:', e2);
              }
            }
          }
          if(btnStart){ btnStart.addEventListener('click',function(e){
            e.preventDefault();
            e.stopPropagation();
            
            var home=document.getElementById('home');
            if(home){ 
              home.style.display='none'; 
              // Don't remove home-visible class yet - wait for game to actually start
              // It will be removed when gamePlaying event fires
            }
            // Hide banner when game starts (direct call like Space Battle)
            try{ hideBanner(); }catch(e){}
            setTimeout(function(){ 
              console.log('Pacman: Home Start button - firing N key');
              fireKey(78); // 'N' to start
              // Button will change from Start to Pause when gamePlaying event fires
            }, 150);
            return false;
          }); }
          if(btnHelp){ btnHelp.addEventListener('click',function(){ if(help){ help.style.display='flex'; } }); }
          if(btnClose){ btnClose.addEventListener('click',function(){ if(help){ help.style.display='none'; } }); }
          
          // Sound button icon toggle logic
          const soundBtn = document.querySelector('.sound-btn');
          if (soundBtn) {
            // Initial state check
            function updateSoundIcon() {
              const isSoundDisabled = localStorage["soundDisabled"] === "true";
              soundBtn.innerHTML = isSoundDisabled ? 'üîá Sound' : 'üîä Sound';
            }
            
            // Update icon on click and keypress
            soundBtn.addEventListener('click', function() {
              // Fire 'S' key event to trigger sound toggle
              fireKey(83);
              setTimeout(updateSoundIcon, 200); // Wait for localStorage to update
            });
            
            // Listen for 'S' key press to update icon
            document.addEventListener('keydown', function(e) {
              if (e.keyCode === 83) { // 'S' key
                setTimeout(updateSoundIcon, 200);
              }
            });
            
            // Set initial state
            updateSoundIcon();
            
            // Refresh icon every second to ensure sync
            setInterval(updateSoundIcon, 1000);
          }
          
          // Single button for Start/Pause/Resume
          var startPauseBtn = null;
          var currentGameState = 'WAITING';
          var isProcessingClick = false; // Debounce flag
          
          // Function to update button text and state
          function updateButtonState(newState) {
            currentGameState = newState;
            
            if (!startPauseBtn) startPauseBtn = document.querySelector('.btn-start-pause');
            if (!startPauseBtn) return;
            
            if (newState === 'WAITING') {
              // Show Start button
              startPauseBtn.innerHTML = '‚ñ∂ Start';
              startPauseBtn.disabled = false;
              startPauseBtn.style.opacity = '1';
              startPauseBtn.style.cursor = 'pointer';
              startPauseBtn.classList.remove('btn-disabled');
              startPauseBtn.setAttribute('data-key', '78'); // N key for start
              startPauseBtn.setAttribute('data-state', 'waiting'); // For CSS styling
              console.log('Pacman: Button set to Start');
              
            } else if (newState === 'PLAYING' || newState === 'COUNTDOWN') {
              // Show Pause button
              startPauseBtn.innerHTML = '‚è∏ Pause';
              startPauseBtn.disabled = false;
              startPauseBtn.style.opacity = '1';
              startPauseBtn.style.cursor = 'pointer';
              startPauseBtn.classList.remove('btn-disabled');
              startPauseBtn.setAttribute('data-key', '80'); // P key for pause
              startPauseBtn.setAttribute('data-state', 'playing'); // For CSS styling
              console.log('Pacman: Button set to Pause');
              
            } else if (newState === 'PAUSE') {
              // Show Resume button
              startPauseBtn.innerHTML = '‚ñ∂ Resume';
              startPauseBtn.disabled = false;
              startPauseBtn.style.opacity = '1';
              startPauseBtn.style.cursor = 'pointer';
              startPauseBtn.classList.remove('btn-disabled');
              startPauseBtn.setAttribute('data-key', '80'); // P key for resume
              startPauseBtn.setAttribute('data-state', 'pause'); // For CSS styling
              console.log('Pacman: Button set to Resume');
            }
          }
          
          // Set up event listeners IMMEDIATELY
          window.addEventListener('gameWaiting', function() {
            console.log('Pacman: Received gameWaiting event');
            // This is for initial waiting state (not game over)
            // Hide controls and show home screen
            document.body.classList.remove('game-playing');
            document.body.classList.add('home-visible');
            
            var controls = document.querySelector('.controls');
            if (controls) {
              controls.style.display = 'none';
              controls.style.visibility = 'hidden';
              controls.style.opacity = '0';
              controls.style.pointerEvents = 'none';
              console.log('Pacman: Controls hidden - game waiting');
            }
            
            updateButtonState('WAITING');
          });
          
          // Handle game over event separately - keep canvas and controls visible
          window.addEventListener('gameOver', function() {
            console.log('Pacman: Received gameOver event');
            // Game over - keep canvas visible AND show controls so user can start new game
            document.body.classList.remove('game-playing');
            document.body.classList.remove('home-visible'); // Remove if it was added
            document.body.classList.add('game-over'); // Add game-over class to keep canvas visible
            
            // Keep controls visible so user can press Start to play again
            var controls = document.querySelector('.controls');
            if (controls) {
              controls.style.display = 'block';
              controls.style.visibility = 'visible';
              controls.style.opacity = '1';
              controls.style.pointerEvents = 'auto';
              console.log('Pacman: Controls kept visible - game over, user can start new game');
            }
            
            // Ensure canvas stays visible
            var gameWrapper = document.querySelector('.game-wrapper');
            var pacman = document.getElementById('pacman');
            if (gameWrapper) {
              gameWrapper.style.display = 'flex';
              gameWrapper.style.visibility = 'visible';
            }
            if (pacman) {
              pacman.style.display = 'block';
              pacman.style.visibility = 'visible';
            }
            
            updateButtonState('WAITING');
          });
          
          window.addEventListener('gamePlaying', function() {
            console.log('Pacman: Received gamePlaying event');
            // Remove home-visible and game-over classes when game actually starts playing
            document.body.classList.remove('home-visible');
            document.body.classList.remove('game-over');
            // Add game-playing class to show controls
            document.body.classList.add('game-playing');
            
            // Make sure controls are visible when game starts
            var controls = document.querySelector('.controls');
            if (controls) {
              controls.style.display = 'block';
              controls.style.visibility = 'visible';
              controls.style.opacity = '1';
              controls.style.pointerEvents = 'auto';
              console.log('Pacman: Controls shown when game started');
            }
            
            updateButtonState('PLAYING');
          });
          
          window.addEventListener('gamePaused', function() {
            console.log('Pacman: Received gamePaused event');
            updateButtonState('PAUSE');
          });
          
          // Set up button click handler with touch support
          setTimeout(function() {
            startPauseBtn = document.querySelector('.btn-start-pause');
            
            if (startPauseBtn) {
              // Function to handle button action
              function handleButtonAction(e) {
                if (e) {
                e.preventDefault();
                e.stopPropagation();
                }
                
                // Debounce check - reduce time to allow faster clicks
                if (isProcessingClick) {
                  console.log('Pacman: Button action ignored (debounce)');
                  return false;
                }
                
                if (startPauseBtn && startPauseBtn.disabled) {
                  console.log('Pacman: Button is disabled, ignoring action');
                  return false;
                }
                
                console.log('Pacman: Button action triggered, current state:', currentGameState);
                console.log('Pacman: Button element:', startPauseBtn);
                console.log('Pacman: Button innerHTML:', startPauseBtn ? startPauseBtn.innerHTML : 'N/A');
                console.log('Pacman: Button disabled:', startPauseBtn ? startPauseBtn.disabled : 'N/A');
                
                // Set debounce flag
                isProcessingClick = true;
                
                // Fire the appropriate key - use button text as primary check, state as fallback
                var keyCode = 0;
                var buttonText = startPauseBtn ? startPauseBtn.innerHTML.trim() : '';
                
                // Check button text first (more reliable)
                if (buttonText.includes('Start') || buttonText.includes('‚ñ∂ Start')) {
                  // Start the game - fire N key
                  keyCode = 78;
                  console.log('Pacman: Button shows Start, firing N key, keyCode:', keyCode);
                } else if (buttonText.includes('Pause') || buttonText.includes('‚è∏') || buttonText.includes('Resume') || buttonText.includes('‚ñ∂ Resume')) {
                  // Pause or Resume the game - fire P key (app.js handles based on actual state)
                  keyCode = 80;
                  console.log('Pacman: Button shows Pause/Resume, firing P key, keyCode:', keyCode, 'Button text:', buttonText);
                } else {
                  // Fallback to state-based logic
                  if (currentGameState === 'WAITING') {
                    keyCode = 78;
                    console.log('Pacman: Fallback - WAITING state, firing N key');
                  } else if (currentGameState === 'PLAYING' || currentGameState === 'COUNTDOWN' || currentGameState === 'PAUSE') {
                    keyCode = 80;
                    console.log('Pacman: Fallback - firing P key based on state:', currentGameState);
                  } else {
                    console.error('Pacman: Cannot determine action! Button text:', buttonText, 'State:', currentGameState);
                    isProcessingClick = false;
                    return false;
                  }
                }
                
                // Fire the key immediately - app.js will handle based on actual game state
                if (keyCode > 0) {
                  console.log('Pacman: About to call fireKey with keyCode:', keyCode);
                  try {
                    fireKey(keyCode);
                    console.log('Pacman: fireKey called successfully');
                  } catch(err) {
                    console.error('Pacman: Error calling fireKey:', err);
                    isProcessingClick = false;
                    return false;
                  }
                } else {
                  console.error('Pacman: No valid keyCode! Button text:', buttonText, 'State:', currentGameState);
                  isProcessingClick = false;
                  return false;
                }
                
                // Reset debounce after shorter delay
                  setTimeout(function() {
                    isProcessingClick = false;
                    console.log('Pacman: Debounce reset');
                }, 200);
                
                return true;
              }
              
              // Touch events (for mobile)
              var touchStartTime = 0;
              startPauseBtn.addEventListener('touchstart', function(e) {
                e.preventDefault();
                e.stopPropagation();
                touchStartTime = Date.now();
                // Haptic feedback
                if (navigator.vibrate) {
                  navigator.vibrate(10);
                }
              }, {passive: false});
              
              startPauseBtn.addEventListener('touchend', function(e) {
                e.preventDefault();
                e.stopPropagation();
                // Only fire if it was a quick tap (not a long press)
                var touchDuration = Date.now() - touchStartTime;
                if (touchDuration < 500 && touchDuration > 0) {
                  console.log('Pacman: Touch end detected, duration:', touchDuration);
                  handleButtonAction(e);
                }
              }, {passive: false});
              
              // Click event (for desktop/mouse) - use capture phase to ensure it fires
              startPauseBtn.addEventListener('click', function(e) {
                console.log('Pacman: Click event detected on start-pause button');
                handleButtonAction(e);
              }, true); // Use capture phase
            }
            
            // Initial state
            updateButtonState('WAITING');
            
            // Export for debugging
            window.pacmanButtonState = {
              getState: function() { return currentGameState; },
              setState: function(s) { updateButtonState(s); }
            };
          }, 100);
        });
      })();
    </script>
  </body>
</html>


