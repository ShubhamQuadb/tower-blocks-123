<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1, user-scalable=no" />
    <meta name="theme-color" content="#000000" />
    <title>Pacman - Android</title>
    
    <!-- App Icons -->
    <link rel="icon" type="image/svg+xml" sizes="32x32" href="icons/icon-32.svg">
    <link rel="icon" type="image/svg+xml" sizes="16x16" href="icons/icon-32.svg">
    <link rel="apple-touch-icon" sizes="180x180" href="icons/icon-180.svg">
    <link rel="shortcut icon" href="icons/icon-32.svg">
    
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Permanent+Marker" />
    <link rel="stylesheet" href="style.css" />
  </head>
  <body>
    <!-- Splash Screen -->
    <div id="splash" style="position:fixed;inset:0;background:#000;display:flex;align-items:center;justify-content:center;flex-direction:column;z-index:1000;color:#0ff;font-family:'Permanent Marker', cursive;">
      <div style="font-size:28px;margin-bottom:8px;">PACMAN</div>
      <div id="eat-row" style="display:flex;align-items:center;gap:12px;margin:6px 0;">
        <svg id="pacSvg" width="44" height="44" viewBox="0 0 40 40" aria-label="Pacman icon">
          <circle cx="20" cy="20" r="18" fill="#ffeb3b"></circle>
          <circle cx="24" cy="14" r="3" fill="#000"></circle>
          <polygon id="mouth" points="20,20 40,10 40,30" fill="#000"></polygon>
        </svg>
        <span class="dot" style="color:#6ff;font-size:18px;">‚óè</span>
        <span class="dot" style="color:#6ff;font-size:18px;">‚óè</span>
        <span class="dot" style="color:#6ff;font-size:18px;">‚óè</span>
        <span class="dot" style="color:#6ff;font-size:18px;">‚óè</span>
        <span class="dot" style="color:#6ff;font-size:18px;">‚óè</span>
      </div>
      <div style="font-size:14px;color:#9ff">Loading‚Ä¶</div>
    </div>

    <!-- Home Screen (shown before game start) -->
    <div id="home" style="position:fixed;inset:0;display:none;align-items:center;justify-content:center;z-index:900;overflow:hidden;">
      <!-- Modern banner background (behind card) -->
      <div aria-hidden="true" style="position:absolute;inset:0;background:url('./wp13214700-pacman-iphone-wallpapers.jpg') center/cover no-repeat;
      "></div>
      <!-- Accent shapes -->
      <div aria-hidden="true" style="position:absolute;top:-60px;left:-60px;width:240px;height:240px;border-radius:50%;background:linear-gradient(145deg,#00ffa3,#00ccff);filter:blur(20px);opacity:.25"></div>
      <div aria-hidden="true" style="position:absolute;bottom:-70px;right:-50px;width:280px;height:280px;border-radius:50%;background:linear-gradient(145deg,#00ccff,#7c3aed);filter:blur(24px);opacity:.22"></div>
      <!-- 3D banner scene: Pacman and enemies -->
      <style>
        /* Inline styles limited to the home scene */
        #home .scene{position:absolute;inset:0;display:block;pointer-events:none;perspective:1000px}
        #home .stage{position:absolute;left:50%;top:36%;width:92%;max-width:760px;height:190px;transform:translateX(-50%) rotateX(6deg) rotateY(-5deg);transform-style:preserve-3d;filter:drop-shadow(0 14px 26px rgba(0,0,0,.4))}
        #home .track{position:absolute;left:0;right:0;top:55%;height:5px;margin-top:-2.5px;background:linear-gradient(90deg,rgba(255,255,255,.3) 0 14px,rgba(255,255,255,0) 14px 30px);transform:translateZ(-50px)}
        #home .pac{position:absolute;left:110px;top:55%;width:68px;height:68px;border-radius:50%;background:radial-gradient(circle at 30% 30%,#fff176 0%,#ffca28 50%,#f5a623 100%);outline:3px solid rgba(255,255,255,.2);transform:translateY(-50%) translateZ(28px)}
        #home .pac:before{content:"";position:absolute;left:34px;top:14px;width:9px;height:9px;border-radius:50%;background:#0b1020;box-shadow:0 0 0 2px rgba(255,255,255,.2) inset}
        #home .pac .mouth{position:absolute;left:32px;top:34px;width:40px;height:40px;background:conic-gradient(#0b0f1a 0 60deg,transparent 60deg 300deg,#0b0f1a 300deg);border-radius:0 50% 50% 50%;transform:translate(-50%,-50%)}
        #home .dot{position:absolute;top:55%;width:12px;height:12px;border-radius:50%;background:rgba(255,255,255,.95);box-shadow:0 0 10px rgba(255,255,255,.6);transform:translateY(-50%) translateZ(6px)}
        #home .d1{left:180px}#home .d2{left:240px}#home .d3{left:300px}#home .d4{left:360px}#home .d5{left:420px}
        #home .ghost{position:absolute;top:55%;width:58px;height:64px;border-radius:28px 28px 12px 12px;background:radial-gradient(circle at 30% 20%,rgba(255,255,255,.28) 0 24%,transparent 26%),var(--gcol);
          transform:translateY(-50%) translateZ(22px);box-shadow:0 12px 22px rgba(0,0,0,.3);outline:3px solid rgba(255,255,255,.18)}
        #home .ghost:before,#home .ghost:after{content:"";position:absolute;top:18px;width:14px;height:14px;border-radius:50%;background:#fff}
        #home .ghost:before{left:12px}#home .ghost:after{left:31px}
        #home .ghost .pupil{position:absolute;top:24px;left:18px;width:9px;height:9px;border-radius:50%;background:#08243f}
        #home .g1{--gcol:#22d3ee;left:500px}
        #home .g2{--gcol:#f472b6;left:570px}
        #home .g3{--gcol:#fb7185;left:640px}
      </style>
      
      <div class="scene" aria-hidden="true">
        <div class="stage">
          <div class="track"></div>
          <div class="pac"><div class="mouth"></div></div>
          <div class="dot d1"></div>
          <div class="dot d2"></div>
          <div class="dot d3"></div>
          <div class="dot d4"></div>
          <div class="dot d5"></div>
          <div class="ghost g1"><div class="pupil"></div></div>
          <div class="ghost g2"><div class="pupil"></div></div>
          <div class="ghost g3"><div class="pupil"></div></div>
        </div>
      </div>
      <!-- Content card (above banner) -->
      <div style="position:relative;z-index:2;width:92%;max-width:520px;border-radius:14px;background:rgba(6,12,20,.78);backdrop-filter:blur(6px);padding:16px;border:1px solid rgba(0,204,255,.25);box-shadow:0 12px 40px rgba(0,0,0,.35);text-align:center;color:#eafffb;">
        <div style="font-family:'Permanent Marker', cursive;font-size:26px;letter-spacing:1px;color:#35f7c6;margin-bottom:6px;">Pac-Man</div>
        <div style="font-size:12px;color:#bfe8ff;opacity:.95;margin-bottom:14px;">Modern Smartphone Edition</div>
        <button class="pill-btn sound-btn" data-key="83" aria-label="Toggle Sound (S)">üîä Sound</button>
        <button id="btnStartGame" style="width:100%;padding:12px 10px;margin:6px 0;background:linear-gradient(90deg,#00ffaa,#00ccff);border:none;border-radius:10px;color:#001;font-weight:700;letter-spacing:.5px;box-shadow:0 6px 16px rgba(0,204,255,.35);">START GAME</button>
        <button id="btnHelp" style="width:100%;padding:10px;margin:6px 0;background:rgba(13,34,48,.9);border:1px solid rgba(0,170,255,.45);border-radius:10px;color:#bfe8ff;">HELP</button>
      </div>
    </div>

    <!-- Help Modal -->
    <div id="helpModal" style="position:fixed;inset:0;background:rgba(0,0,0,.75);display:none;align-items:center;justify-content:center;z-index:950;">
      <div style="width:92%;max-width:560px;background:#0b1116;border:1px solid #0aa;border-radius:10px;color:#d9f7ff;padding:14px;">
        <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:8px;">
          <div style="font-weight:700;color:#6df;">How to Play</div>
          <button id="btnCloseHelp" style="background:#07202c;color:#9ad;border:1px solid #0aa;border-radius:6px;padding:6px 10px;">Close</button>
        </div>
        <ul style="margin:0;padding-left:18px;line-height:1.6;color:#bfe8ff;text-align:left;">
          <li>Use the on-screen arrows to move Pac-Man.</li>
          <li>Eat all dots to clear the level.</li>
          <li>Power pills make ghosts vulnerable for a short time.</li>
          <li>Tap the Start/Pause/Resume button to start, pause, or resume the game.</li>
          <li>Use the Sound button to toggle audio on/off.</li>
          <li><strong>Lives:</strong> The game starts with 2 lives. After 2 game overs, the game will restart automatically.</li>
        </ul>
      </div>
    </div>
    <!-- Rewarded Video Prompt -->
    <div id="rewardModal" class="reward-modal" aria-hidden="true" role="dialog" aria-labelledby="rewardTitle">
      <div class="reward-modal__card">
        <div class="reward-modal__header">
          <div class="reward-modal__icon">üéÅ</div>
          <div>
            <div id="rewardTitle" class="reward-modal__title">Continue Playing?</div>
            <div id="rewardSubtitle" class="reward-modal__subtitle">Watch a short video to get an extra life.</div>
          </div>
        </div>
        <div class="reward-modal__body">
          <p id="rewardMessage">Watch a rewarded video and jump back into the action with one extra life.</p>
          <div class="reward-modal__score" id="rewardScore"></div>
        </div>
        <div class="reward-modal__actions">
          <button id="btnRewardWatch" class="reward-modal__btn reward-modal__btn--primary">‚ñ∂ Watch &amp; Continue</button>
          <button id="btnRewardSkip" class="reward-modal__btn reward-modal__btn--ghost">Skip for now</button>
        </div>
      </div>
    </div>
    <div id="nextLevelModal" class="next-level-modal" aria-hidden="true" role="dialog" aria-labelledby="nextLevelTitle">
      <div class="next-level-modal__card">
        <div class="next-level-modal__badge">üöÄ</div>
        <h2 id="nextLevelTitle" class="next-level-modal__title">Next Level Ready!</h2>
        <p id="nextLevelMessage" class="next-level-modal__message">Tap start when you're ready to continue.</p>
        <div class="next-level-modal__stats">
          <div class="next-level-modal__stat">
            <span>Upcoming Level</span>
            <strong id="nextLevelLevel">Level 2</strong>
          </div>
          <div class="next-level-modal__stat">
            <span>Current Score</span>
            <strong id="nextLevelScore">0</strong>
          </div>
        </div>
        <button id="btnStartNextLevel" class="next-level-modal__btn">Start Next Level</button>
      </div>
    </div>
    <!-- Game Over Overlay -->
    <div id="gameOverOverlay" aria-hidden="true">
      <div class="overlay-card" role="dialog" aria-labelledby="gameOverTitle" aria-describedby="gameOverScore">
        <div class="overlay-icon"><img src="icons/icon-56.svg" alt="Pacman" style="width:56px;height:56px;" /></div>
        <div id="gameOverTitle" class="overlay-title">Game Over</div>
        <p class="overlay-sub">Final Score</p>
        <div id="gameOverScore" class="overlay-score">0</div>
        <div class="overlay-metrics">
          <div class="metric">
            <span>Level Reached</span>
            <strong id="gameOverLevel">1</strong>
          </div>
          <div class="metric">
            <span>Best Score</span>
            <strong id="gameOverBest">0</strong>
          </div>
        </div>
        <div class="overlay-actions">
          <button id="btnPlayAgain" class="overlay-primary">PLAY AGAIN</button>
          <button id="btnCloseGameOver" class="overlay-secondary">Back to Home</button>
        </div>
      </div>
    </div>
    <div id="shim">shim for font face</div>
    <h1>üéÆ Pac-man</h1>
    <p id="instructions">
      Tap the arrow buttons to move Pac-Man and eat all dots
    </p>

    <!-- Game Wrapper (hidden initially, shown when game starts) -->
    <div class="game-wrapper" style="display:none;">
      <button id="btnCloseGame" class="close-game-btn" aria-label="Close game and return to home">‚úï</button>
      <div id="pacman" aria-label="Pacman Canvas Wrapper"></div>
    </div>

    <!-- Mobile Controls -->
    <div class="controls" aria-label="Mobile Controls">
      <!-- Top row: Start/Pause/Resume button -->
      <div class="controls-row controls-top">
        <button class="pill-btn btn-start-pause" data-key="78" aria-label="Start/Pause/Resume">‚ñ∂ Start</button>
      </div>
      <!-- Bottom row: Arrow buttons -->
      <div class="controls-row">
        <button class="ctrl-btn btn-up" data-key="38" aria-label="Up">‚ñ≤</button>
      </div>
      <div class="controls-row">
        <button class="ctrl-btn btn-left" data-key="37" aria-label="Left">‚óÄ</button>
        <button class="ctrl-btn btn-down" data-key="40" aria-label="Down">‚ñº</button>
        <button class="ctrl-btn btn-right" data-key="39" aria-label="Right">‚ñ∂</button>
      </div>
    </div>

    <script src="jiogames_sp_wrapper.js" type="text/javascript"></script>
    <script>
        // Console logging for smartphone SDK
        console.log("Pacman - Smartphone SDK initialized");
        
        // Hide controls immediately when page loads (during splash)
        (function() {
          var controls = document.querySelector('.controls');
          if (controls) {
            controls.style.display = 'none';
            controls.style.visibility = 'hidden';
            controls.style.opacity = '0';
            controls.style.pointerEvents = 'none';
            console.log("Pacman: Controls hidden during splash");
          }
          
          // Hide close button during splash/loading
          var closeBtn = document.getElementById('btnCloseGame');
          if (closeBtn) {
            closeBtn.style.display = 'none';
            closeBtn.style.visibility = 'hidden';
            closeBtn.style.opacity = '0';
            console.log("Pacman: Close button hidden during splash");
          }
        })();
        
        window.addEventListener('load', function() {
            console.log("Pacman Smartphone - Page Loaded");
            // Note: cacheAd() will be called ONLY at game start (in startNewGame())
            // NOT during initialization per JioGames guidelines
            
            // Hide splash immediately after load, then show home (no glitch)
          setTimeout(function(){
            var s=document.getElementById('splash'); 
            if(s){ 
              s.style.display='none'; 
              console.log("Pacman: Splash hidden");
            }
            var h=document.getElementById('home'); 
            if(h){ 
              h.style.display='flex'; 
              document.body.classList.add('home-visible');
              console.log("Pacman: Home shown, controls should stay hidden");
            }
          }, 300);
            
            // Banner loading removed per user request
            
            // Note: cacheAd() will be called ONLY at game start (in startNewGame())
            // NOT during initialization per JioGames guidelines
        });
    </script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/2.1.3/jquery.min.js" type="text/javascript"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/modernizr/2.8.3/modernizr.min.js" type="text/javascript"></script>
    <script src="./app.js" type="text/javascript"></script>

    <!-- Touch/Click Controls Script -->
    <script>
      (function() {
        function fireKey(code) {
          try {
            const ev = new KeyboardEvent('keydown', {bubbles: true, cancelable: true, keyCode: code, which: code});
            Object.defineProperty(ev, 'keyCode', {get: function(){return code;}});
            Object.defineProperty(ev, 'which', {get: function(){return code;}});
            document.dispatchEvent(ev);
          } catch (e) {
            // Fallback for older browsers
            const ev = document.createEvent('Event');
            ev.initEvent('keydown', true, true);
            ev.keyCode = code;
            ev.which = code;
            document.dispatchEvent(ev);
          }
        }

        // handle tap & press-and-hold to repeat
        let repeatTimer = null;
        const REPEAT_MS = 120; // Faster response for smartphones

        function startRepeat(code) {
          fireKey(code);
          clearInterval(repeatTimer);
          repeatTimer = setInterval(function(){ fireKey(code); }, REPEAT_MS);
        }
        function stopRepeat() {
          clearInterval(repeatTimer);
          repeatTimer = null;
        }

        function bindBtn(btn) {
          const code = parseInt(btn.getAttribute('data-key'), 10);
          var touchHandled = false;
          
          // Touch (better for Android) - handle first
          btn.addEventListener('touchstart', function(e){ 
            e.preventDefault();
            touchHandled = true;
            startRepeat(code);
            // Haptic feedback for Android
            if (navigator.vibrate) {
              navigator.vibrate(10);
            }
          }, {passive:false});
          
          btn.addEventListener('touchend', function(e){ 
            e.preventDefault(); 
            stopRepeat();
            // Reset flag after delay to prevent mouse event
            setTimeout(function() {
              touchHandled = false;
            }, 300);
          }, {passive:false});
          
          btn.addEventListener('touchcancel', function() {
            stopRepeat();
            setTimeout(function() {
              touchHandled = false;
            }, 300);
          }, {passive:true});
          
          // Mouse (only if touch wasn't handled)
          btn.addEventListener('mousedown', function(e){
            if (!touchHandled) {
              startRepeat(code);
            }
          });
          btn.addEventListener('mouseup', function(e) {
            if (!touchHandled) {
              stopRepeat();
            }
          });
          btn.addEventListener('mouseleave', function(e) {
            if (!touchHandled) {
              stopRepeat();
            }
          });
          btn.addEventListener('click', function(e){ 
            e.preventDefault();
          });
        }

        document.addEventListener('DOMContentLoaded', function(){
          // Bind buttons except start-pause button (which has custom handler)
          document.querySelectorAll('.ctrl-btn, .pill-btn:not(.btn-start-pause)').forEach(bindBtn);
          // Splash Pacman eating animation
          (function(){
            var mouth = document.getElementById('mouth');
            var dots = Array.prototype.slice.call(document.querySelectorAll('#eat-row .dot'));
            var open = true, i = 0;
            setInterval(function(){
              // toggle mouth shape
              if (mouth) {
                mouth.setAttribute('points', open ? '20,20 40,19 40,21' : '20,20 40,10 40,30');
                open = !open;
              }
              // eat a dot every other toggle
              if (!open && dots.length) {
                if (i < dots.length) {
                  dots[i].style.opacity = '0';
                  i++;
                } else {
                  // reset
                  dots.forEach(function(d){ d.style.opacity = '1'; });
                  i = 0;
                }
              }
            }, 200);
          })();
          // Track if game has been started by user (to prevent gameWaiting from hiding canvas)
          var gameStartedByUser = false;
          
          // Home screen bindings
          var hs=document.getElementById('home');
          var btnStart=document.getElementById('btnStartGame');
          var btnHelp=document.getElementById('btnHelp');
          var help=document.getElementById('helpModal');
          var btnClose=document.getElementById('btnCloseHelp');
          var rewardModal=document.getElementById('rewardModal');
          var rewardMessage=document.getElementById('rewardMessage');
          var rewardScore=document.getElementById('rewardScore');
          var btnRewardWatch=document.getElementById('btnRewardWatch');
          var btnRewardSkip=document.getElementById('btnRewardSkip');
          var rewardCallbacks=null;
          var nextLevelModal=document.getElementById('nextLevelModal');
          var nextLevelMessage=document.getElementById('nextLevelMessage');
          var nextLevelLevel=document.getElementById('nextLevelLevel');
          var nextLevelScore=document.getElementById('nextLevelScore');
          var btnStartNextLevel=document.getElementById('btnStartNextLevel');
          var nextLevelCallbacks=null;
          var gameOverOverlay=document.getElementById('gameOverOverlay');
          var gameOverScore=document.getElementById('gameOverScore');
          var gameOverLevel=document.getElementById('gameOverLevel');
          var gameOverBest=document.getElementById('gameOverBest');
          var btnPlayAgain=document.getElementById('btnPlayAgain');
          var btnCloseGameOver=document.getElementById('btnCloseGameOver');
          var BEST_SCORE_KEY='pacmanBestScore';
          window.isNextLevelPromptVisible = false;
          window.nextLevelDialogText = null;
          window.skipCountdownForNextLevel = false;
          
          function closeRewardPrompt(action){
            if (rewardModal) {
              rewardModal.classList.remove('visible');
              rewardModal.setAttribute('aria-hidden','true');
            }
            
            // Resume game and audio when reward popup closes (only if not game over)
            try {
              if (action !== 'confirm' || !window.isRVReady) {
                // Only resume if not continuing with extra life
                var allAudio = document.querySelectorAll('audio');
                for (var i = 0; i < allAudio.length; i++) {
                  if (allAudio[i] && allAudio[i].paused) {
                    // Don't auto-resume, let game state handle it
                  }
                }
              }
            } catch(e) {
              console.log('Pacman: Error handling audio on reward popup close', e);
            }
            var callbacks = rewardCallbacks;
            rewardCallbacks = null;
            if (!callbacks) { return; }
            if (action === 'confirm' && typeof callbacks.onConfirm === 'function') {
              callbacks.onConfirm();
            } else if (action === 'cancel' && typeof callbacks.onCancel === 'function') {
              callbacks.onCancel();
            }
          }
          
          window.showRewardPrompt = function(options){
            options = options || {};
            if (!rewardModal) {
              if (typeof options.onCancel === 'function') {
                options.onCancel();
              }
              return;
            }
            rewardCallbacks = options;
            if (rewardMessage) {
              rewardMessage.textContent = options.message || 'Watch a rewarded video and jump back into the action with one extra life.';
            }
            if (rewardScore) {
              if (typeof options.score !== 'undefined') {
                rewardScore.style.display = 'block';
                rewardScore.textContent = 'Score: ' + options.score;
              } else {
                rewardScore.style.display = 'none';
                rewardScore.textContent = '';
              }
            }
            rewardModal.classList.add('visible');
            rewardModal.setAttribute('aria-hidden','false');
            
            // Pause game and audio immediately when RV confirmation popup opens
            // Use both KeyboardEvent and direct pause to ensure game stops
            try {
              // Method 1: Fire P key to pause game - use direct KeyboardEvent dispatch for reliability
              if (typeof document !== 'undefined') {
                var pauseEvent = new KeyboardEvent('keydown', {
                  bubbles: true,
                  cancelable: true,
                  keyCode: 80,
                  which: 80,
                  key: 'P'
                });
                Object.defineProperty(pauseEvent, 'keyCode', {get: function(){return 80;}});
                Object.defineProperty(pauseEvent, 'which', {get: function(){return 80;}});
                document.dispatchEvent(pauseEvent);
                console.log('Pacman: P key event dispatched to pause game - RV confirmation popup opened');
              }
              
              // Method 2: Also pause audio directly and ensure game state is paused
              var allAudio = document.querySelectorAll('audio');
              for (var i = 0; i < allAudio.length; i++) {
                if (allAudio[i] && !allAudio[i].paused) {
                  allAudio[i].pause();
                  console.log('Pacman: Audio paused - RV confirmation popup opened');
                }
              }
              
              // Method 3: Dispatch gamePaused event to ensure UI updates
              try {
                window.dispatchEvent(new CustomEvent('gamePaused'));
              } catch(e) {
                console.log('Pacman: Error dispatching gamePaused event', e);
              }
              
              console.log('Pacman: Game and audio paused - RV confirmation popup opened');
            } catch(e) {
              console.log('Pacman: Error pausing game/audio on reward popup', e);
            }
          };
          
          if (btnRewardWatch) {
            btnRewardWatch.addEventListener('click', function(){
              closeRewardPrompt('confirm');
            });
          }
          if (btnRewardSkip) {
            btnRewardSkip.addEventListener('click', function(){
              closeRewardPrompt('cancel');
            });
          }
          if (rewardModal) {
            rewardModal.addEventListener('click', function(e){
              if (e.target === rewardModal) {
                closeRewardPrompt('cancel');
              }
            });
          }
          document.addEventListener('keydown', function(evt){
            if (evt.key === 'Escape' && rewardModal && rewardModal.classList.contains('visible')) {
              evt.preventDefault();
              closeRewardPrompt('cancel');
            }
          });

          window.showNextLevelPrompt = function(options){
            options = options || {};
            if (!nextLevelModal) {
              if (typeof options.onStart === 'function') {
                options.onStart();
              }
              return;
            }
            nextLevelCallbacks = options;
            window.isNextLevelPromptVisible = true;
            window.nextLevelDialogText = options.dialogText || 'Tap the Next Level button to continue.';
            if (startPauseBtn) {
              startPauseBtn.disabled = true;
              startPauseBtn.classList.add('btn-disabled');
              startPauseBtn.style.opacity = '0.5';
            }
            if (nextLevelMessage) {
              nextLevelMessage.textContent = options.message || 'Tap start when you are ready to continue.';
            }
            if (nextLevelLevel) {
              nextLevelLevel.textContent = options.level ? ('Level ' + options.level) : 'Next Level';
            }
            if (nextLevelScore) {
              var scoreValue = (typeof options.score === 'number') ? options.score : (options.score || 0);
              nextLevelScore.textContent = scoreValue;
            }
            if (btnStartNextLevel) {
              btnStartNextLevel.textContent = options.buttonLabel || (options.level ? ('Start Level ' + options.level) : 'Start Next Level');
            }
            nextLevelModal.classList.add('visible');
            nextLevelModal.setAttribute('aria-hidden','false');
          };
          
          window.hideNextLevelPrompt = function(){
            if (!nextLevelModal) {
              nextLevelCallbacks = null;
              window.isNextLevelPromptVisible = false;
              return;
            }
            nextLevelModal.classList.remove('visible');
            nextLevelModal.setAttribute('aria-hidden','true');
            nextLevelCallbacks = null;
            window.isNextLevelPromptVisible = false;
            window.nextLevelDialogText = null;
            if (startPauseBtn) {
              startPauseBtn.disabled = false;
              startPauseBtn.classList.remove('btn-disabled');
              startPauseBtn.style.opacity = '';
            }
          };
          
          if (btnStartNextLevel) {
            btnStartNextLevel.addEventListener('click', function(){
              window.skipCountdownForNextLevel = true;
              var cb = nextLevelCallbacks && typeof nextLevelCallbacks.onStart === 'function'
                ? nextLevelCallbacks.onStart
                : null;
              if (nextLevelModal && nextLevelModal.classList.contains('visible')) {
                window.hideNextLevelPrompt();
              }
              if (cb) {
                setTimeout(function(){
                  cb();
                }, 0);
              }
            });
          }

          function ensureHomeSceneVisible() {
            document.body.classList.add('home-visible');
            document.body.classList.add('game-over');
            document.body.classList.remove('game-playing');
            if (hs) {
              hs.style.display = 'flex';
            }
            
            // Hide controls when showing home scene
            var controls = document.querySelector('.controls');
            if (controls) {
              controls.style.display = 'none';
              controls.style.visibility = 'hidden';
              controls.style.opacity = '0';
              controls.style.pointerEvents = 'none';
              controls.style.setProperty('display', 'none', 'important');
              controls.style.setProperty('visibility', 'hidden', 'important');
            }
            
            var closeBtn = document.getElementById('btnCloseGame');
            if (closeBtn) {
              closeBtn.style.display = 'none';
              closeBtn.style.visibility = 'hidden';
              closeBtn.style.opacity = '0';
            }
          }
          
          window.showGameOverOverlay = function(details){
            if (!gameOverOverlay) { return; }
            details = details || {};
            var score = typeof details.score === 'number' ? details.score : 0;
            var levelReached = typeof details.level === 'number' ? details.level : 1;
            
            ensureHomeSceneVisible();
            
            if (gameOverScore) {
              gameOverScore.textContent = score;
            }
            if (gameOverLevel) {
              gameOverLevel.textContent = levelReached;
            }
            
            var bestScore = parseInt(localStorage.getItem(BEST_SCORE_KEY) || '0', 10);
            if (score > bestScore) {
              bestScore = score;
              localStorage.setItem(BEST_SCORE_KEY, String(bestScore));
            }
            if (gameOverBest) {
              gameOverBest.textContent = bestScore;
            }
            
            gameOverOverlay.classList.add('visible');
            gameOverOverlay.setAttribute('aria-hidden', 'false');
            
            // Ensure game and audio are paused when game over popup opens
            try {
              // Fire P key to pause game
              if (typeof document !== 'undefined') {
                var pauseEvent = new KeyboardEvent('keydown', {
                  bubbles: true,
                  cancelable: true,
                  keyCode: 80,
                  which: 80,
                  key: 'P'
                });
                Object.defineProperty(pauseEvent, 'keyCode', {get: function(){return 80;}});
                Object.defineProperty(pauseEvent, 'which', {get: function(){return 80;}});
                document.dispatchEvent(pauseEvent);
                console.log('Pacman: P key event dispatched to pause game - Game over popup opened');
              }
              // Also pause audio directly
              var allAudio = document.querySelectorAll('audio');
              for (var i = 0; i < allAudio.length; i++) {
                if (allAudio[i] && !allAudio[i].paused) {
                  allAudio[i].pause();
                  console.log('Pacman: Audio paused - Game over popup opened');
                }
              }
              // Dispatch gamePaused event
              try {
                window.dispatchEvent(new CustomEvent('gamePaused'));
              } catch(e) {
                console.log('Pacman: Error dispatching gamePaused event', e);
              }
              console.log('Pacman: Game and audio paused - Game over popup opened');
            } catch(e) {
              console.log('Pacman: Error pausing game/audio on game over popup', e);
            }
          };
          
          window.hideGameOverOverlay = function(options){
            options = options || {};
            if (!gameOverOverlay) { return; }
            gameOverOverlay.classList.remove('visible');
            gameOverOverlay.setAttribute('aria-hidden', 'true');
            
            if (options.hideHome) {
              if (hs) {
                hs.style.display = 'none';
              }
              document.body.classList.remove('home-visible');
              document.body.classList.remove('game-over');
              // Reset game over flag when hiding overlay to start new game
              window.isGameOver = false;
              // Banner hide removed per user request
            } else {
              // Returning to home screen - hide controls and show home
              document.body.classList.remove('game-playing');
              document.body.classList.remove('game-over');
              document.body.classList.add('home-visible');
              // Reset game over flag when returning to home
              window.isGameOver = false;
              
              // Hide controls explicitly
              var controls = document.querySelector('.controls');
              if (controls) {
                controls.style.display = 'none';
                controls.style.visibility = 'hidden';
                controls.style.opacity = '0';
                controls.style.pointerEvents = 'none';
                controls.style.setProperty('display', 'none', 'important');
                controls.style.setProperty('visibility', 'hidden', 'important');
              }
              
              // Show home screen
              if (hs) {
                hs.style.display = 'flex';
              }
              
              // Hide game canvas
              var gameWrapper = document.querySelector('.game-wrapper');
              if (gameWrapper) {
                gameWrapper.style.display = 'none';
              }
              var pacman = document.getElementById('pacman');
              if (pacman) {
                pacman.style.display = 'none';
              }
              
              // Hide game UI elements
              var h1 = document.querySelector('h1');
              if (h1) {
                h1.style.display = 'none';
              }
              var instructions = document.getElementById('instructions');
              if (instructions) {
                instructions.style.display = 'none';
              }
              
              // Reset game started flag
              gameStartedByUser = false;
              
              // Show interstitial ad before returning to home (Back to Home flow) - no caching
              try {
                if (typeof showAd === 'function' && window.isAdReady === true) {
                  console.log('Pacman: Showing interstitial ad before returning to home (if available)');
                  // Set flag to prevent game caching when ad closes
                  window.skipGameCachingOnAdClose = true;
                  showAd();
                } else {
                  console.log('Pacman: Ad not available, skipping ad show on Back to Home');
                }
              } catch(e) {
                console.log('Error showing ad:', e);
              }
              
              console.log('Pacman: Returned to home screen, controls hidden');
            }
          };
          
          if (btnPlayAgain) {
            btnPlayAgain.addEventListener('click', function(){
              console.log('Pacman: Play Again button clicked');
              // Reset game start caching flag - allow caching for new game session
              window.gameStartCachingDone = false;
              // Reset caching flags to allow fresh caching
              if (typeof resetCachingFlags === 'function') {
                resetCachingFlags();
              }
              // Reset RV flags to allow caching on new game start
              window.skipCachingAfterRV = false;
              window.continuingFromRV = false;
              console.log('Pacman: Reset RV flags on Play Again - caching will happen');
              window.hideGameOverOverlay({hideHome: true});
              if (typeof window.hideNextLevelPrompt === 'function') {
                window.hideNextLevelPrompt();
              }
              gameStartedByUser = true;
              // Clear game over flag to allow game to start
              window.isGameOver = false;
              // Hide home screen and show game immediately
              var home = document.getElementById('home');
              if (home) {
                home.style.display = 'none';
              }
              document.body.classList.remove('home-visible');
              document.body.classList.remove('game-over');
              document.body.classList.add('game-playing');
              
              // Show game wrapper and canvas
              var gameWrapper = document.querySelector('.game-wrapper');
              if (gameWrapper) {
                gameWrapper.style.display = 'flex';
              }
              var pacman = document.getElementById('pacman');
              if (pacman) {
                pacman.style.display = 'block';
              }
              
              // Start game - fire N key
              setTimeout(function() {
                fireKey(78);
                // Ensure button shows Pause after game starts (not Start)
                setTimeout(function() {
                  if (typeof updateButtonState === 'function') {
                    updateButtonState('COUNTDOWN'); // This will update to Pause when gamePlaying event fires
                  }
                }, 100);
              }, 60);
            });
          }
          
          if (btnCloseGameOver) {
            btnCloseGameOver.addEventListener('click', function(){
              console.log('Pacman: Back to Home button clicked');
              // Reset game over flag to allow fresh game start from home page
              window.isGameOver = false;
              // Reset game started flag
              gameStartedByUser = false;
              window.hideGameOverOverlay();
            });
          }
          
          function fireKey(code){
            try{
              console.log('Pacman: fireKey called with code:', code);
              
              // Try modern approach first
              var ev = null;
              try {
                // Modern browsers - create event with initKeyboardEvent or KeyboardEvent
                if (typeof KeyboardEvent !== 'undefined') {
                  ev = new KeyboardEvent('keydown', {
                    bubbles: true,
                    cancelable: true,
                    view: window
                  });
                  
                  // Set keyCode and which using defineProperty for compatibility
                  Object.defineProperty(ev, 'keyCode', {
                    get: function() { return code; },
                    enumerable: true,
                    configurable: true
                  });
                  Object.defineProperty(ev, 'which', {
                    get: function() { return code; },
                    enumerable: true,
                    configurable: true
                  });
                  Object.defineProperty(ev, 'charCode', {
                    get: function() { return 0; },
                    enumerable: true,
                    configurable: true
                  });
                  
                  // Also try setting directly (some browsers allow this)
                  try {
                    ev.keyCode = code;
                    ev.which = code;
                  } catch(e) {
                    // Ignore if not settable
                  }
                }
              } catch(e) {
                console.log('Pacman: Modern KeyboardEvent failed, using fallback');
              }
              
              // Fallback for older browsers
              if (!ev) {
                try {
                  ev = document.createEvent('KeyboardEvent');
                  ev.initKeyboardEvent('keydown', true, true, window, false, false, false, false, 0, code);
                } catch(e) {
                  // Final fallback - use generic event
                  ev = document.createEvent('Event');
                  ev.initEvent('keydown', true, true);
                  ev.keyCode = code;
                  ev.which = code;
                }
              }
              
              // Ensure keyCode is set
              if (ev.keyCode !== code) {
                try {
                  Object.defineProperty(ev, 'keyCode', {
                    get: function() { return code; },
                    enumerable: true,
                    configurable: true
                  });
                  Object.defineProperty(ev, 'which', {
                    get: function() { return code; },
                    enumerable: true,
                    configurable: true
                  });
                } catch(e) {
                  // If defineProperty fails, try direct assignment
                  ev.keyCode = code;
                  ev.which = code;
                }
              }
              
              console.log('Pacman: Dispatching keydown event, keyCode:', ev.keyCode || code, 'which:', ev.which || code);
              
              // Dispatch to document - app.js listens with capture phase (true)
              var result = document.dispatchEvent(ev);
              console.log('Pacman: Event dispatched successfully, defaultPrevented:', ev.defaultPrevented, 'result:', result);
              
              // Also try dispatching directly to window as fallback
              if (!result) {
                console.log('Pacman: Trying window.dispatchEvent as fallback');
                window.dispatchEvent(ev);
              }
              
            }catch(e){
              console.error('Pacman: Error in fireKey:', e, e.stack);
              // Last resort - try to call the keyDown function directly if accessible
              try {
                if (window.PACMAN && typeof window.PACMAN.keyDown === 'function') {
                  console.log('Pacman: Attempting direct keyDown call');
                  var fakeEvent = { keyCode: code, which: code, preventDefault: function(){}, stopPropagation: function(){} };
                  window.PACMAN.keyDown(fakeEvent);
                }
              } catch(e2) {
                console.error('Pacman: Direct call also failed:', e2);
              }
            }
          }
          if(btnStart){ btnStart.addEventListener('click',function(e){
            e.preventDefault();
            e.stopPropagation();
            
            console.log('Pacman: Start Game button clicked on home page');
            // Reset game start caching flag - allow caching for new game session
            window.gameStartCachingDone = false;
            // Reset caching flags to allow fresh caching
            if (typeof resetCachingFlags === 'function') {
              resetCachingFlags();
            }
            // Reset RV flags to allow caching on new game start
            window.skipCachingAfterRV = false;
            window.continuingFromRV = false;
            console.log('Pacman: Reset RV flags on Start Game - caching will happen');
            // Reset game over flag to allow fresh game start
            window.isGameOver = false;
            // Mark that user has started the game
            gameStartedByUser = true;
            if (typeof window.hideGameOverOverlay === 'function') {
              window.hideGameOverOverlay({hideHome: true});
            }
            
            var home=document.getElementById('home');
            if(home){ 
              home.style.display='none'; 
            }
            // Banner hide removed per user request
            
            // Remove home-visible class and show game wrapper immediately
            document.body.classList.remove('home-visible');
            var gameWrapper = document.querySelector('.game-wrapper');
            if (gameWrapper) {
              gameWrapper.style.display = 'flex';
              // Force display to prevent any CSS from hiding it
              gameWrapper.style.setProperty('display', 'flex', 'important');
            }
            var pacman = document.getElementById('pacman');
            if (pacman) {
              pacman.style.display = 'block';
              // Force display to prevent any CSS from hiding it
              pacman.style.setProperty('display', 'block', 'important');
            }
            
            setTimeout(function(){ 
              console.log('Pacman: Home Start button - firing N key');
              fireKey(78); // 'N' to start
              // Button will change from Start to Pause when gamePlaying event fires
            }, 150);
            return false;
          }); }
          if(btnHelp){ btnHelp.addEventListener('click',function(){ if(help){ help.style.display='flex'; } }); }
          if(btnClose){ btnClose.addEventListener('click',function(){ if(help){ help.style.display='none'; } }); }
          
          // Sound button icon toggle logic
          const soundBtn = document.querySelector('.sound-btn');
          if (soundBtn) {
            // Initial state check
            function updateSoundIcon() {
              const isSoundDisabled = localStorage["soundDisabled"] === "true";
              soundBtn.innerHTML = isSoundDisabled ? 'üîá Sound' : 'üîä Sound';
            }
            
            // Update icon on click - immediate response
            soundBtn.addEventListener('click', function() {
              // Toggle sound state immediately
              const isSoundDisabled = localStorage["soundDisabled"] === "true";
              localStorage["soundDisabled"] = String(!isSoundDisabled);
              
              // Update icon immediately
              updateSoundIcon();
              
              // Fire 'S' key event to trigger sound toggle in game
              fireKey(83);
              
              // Update again after a short delay to ensure sync
              setTimeout(updateSoundIcon, 50);
            });
            
            // Listen for 'S' key press to update icon - faster response
            document.addEventListener('keydown', function(e) {
              if (e.keyCode === 83) { // 'S' key
                setTimeout(updateSoundIcon, 50); // Faster update
              }
            });
            
            // Set initial state
            updateSoundIcon();
            
            // Refresh icon every 500ms for faster sync (reduced from 1000ms)
            setInterval(updateSoundIcon, 500);
          }
          
          // Single button for Start/Pause/Resume
          var startPauseBtn = null;
          var currentGameState = 'WAITING';
          var isProcessingClick = false; // Debounce flag
          
          function forcePause(reason) {
            if (typeof window !== 'undefined') {
              if (window.skipPauseKeyOnNextAd) {
                console.log('Pacman: forcePause skipped (' + reason + ') - ad pause flag active');
                return;
              }
              if (window.isNextLevelPromptVisible) {
                console.log('Pacman: forcePause skipped (' + reason + ') - next level prompt active');
                return;
              }
            }
            if (currentGameState === 'PLAYING' || currentGameState === 'COUNTDOWN') {
              console.log('Pacman: ' + reason + ' - auto pausing via P key');
              try {
                fireKey(80);
              } catch(err) {
                console.log('Pacman: Auto pause failed', err);
              }
            }
          }
          
          document.addEventListener('visibilitychange', function() {
            if (document.hidden) {
              forcePause('App hidden');
            }
          });
          
          window.addEventListener('adShown', function() {
            forcePause('Ad shown');
          });
          
          window.addEventListener('blur', function() {
            forcePause('Window blurred');
          });
          
          // Function to update button text and state
          function updateButtonState(newState) {
            currentGameState = newState;
            
            if (!startPauseBtn) startPauseBtn = document.querySelector('.btn-start-pause');
            if (!startPauseBtn) return;
            
            if (newState === 'WAITING') {
              // Show Start button
              startPauseBtn.innerHTML = '‚ñ∂ Start';
              startPauseBtn.disabled = false;
              startPauseBtn.style.opacity = '1';
              startPauseBtn.style.cursor = 'pointer';
              startPauseBtn.classList.remove('btn-disabled');
              startPauseBtn.setAttribute('data-key', '78'); // N key for start
              startPauseBtn.setAttribute('data-state', 'waiting'); // For CSS styling
              console.log('Pacman: Button set to Start');
              
            } else if (newState === 'PLAYING' || newState === 'COUNTDOWN') {
              // Show Pause button
              startPauseBtn.innerHTML = '‚è∏ Pause';
              startPauseBtn.disabled = false;
              startPauseBtn.style.opacity = '1';
              startPauseBtn.style.cursor = 'pointer';
              startPauseBtn.classList.remove('btn-disabled');
              startPauseBtn.setAttribute('data-key', '80'); // P key for pause
              startPauseBtn.setAttribute('data-state', 'playing'); // For CSS styling
              console.log('Pacman: Button set to Pause');
              
            } else if (newState === 'PAUSE') {
              // Show Resume button
              startPauseBtn.innerHTML = '‚ñ∂ Resume';
              startPauseBtn.disabled = false;
              startPauseBtn.style.opacity = '1';
              startPauseBtn.style.cursor = 'pointer';
              startPauseBtn.classList.remove('btn-disabled');
              startPauseBtn.setAttribute('data-key', '80'); // P key for resume
              startPauseBtn.setAttribute('data-state', 'pause'); // For CSS styling
              console.log('Pacman: Button set to Resume');
            }
          }
          
          // Set up event listeners IMMEDIATELY
          window.addEventListener('gameWaiting', function() {
            console.log('Pacman: Received gameWaiting event');
            
            // Don't hide canvas if user has already started the game
            // This prevents canvas from disappearing during countdown or initial state
            if (gameStartedByUser) {
              console.log('Pacman: Ignoring gameWaiting - game already started by user, not updating button');
              return;
            }
            
            // This is for initial waiting state (not game over)
            // Hide controls and show home screen
            document.body.classList.remove('game-playing');
            document.body.classList.add('home-visible');
            
            var controls = document.querySelector('.controls');
            if (controls) {
              controls.style.display = 'none';
              controls.style.visibility = 'hidden';
              controls.style.opacity = '0';
              controls.style.pointerEvents = 'none';
              console.log('Pacman: Controls hidden - game waiting');
            }
            
            // Only update button to Start if not game over and game not started by user
            if (!window.isGameOver && !gameStartedByUser) {
              updateButtonState('WAITING');
            }
          });
          
          // Handle game over event - don't show home immediately, wait for popup
          window.addEventListener('gameOver', function() {
            console.log('Pacman: Received gameOver event');
            // Don't show home screen immediately - it will be shown when game over popup is displayed
            // This prevents home screen from flashing before popup appears
            // Hide home screen initially to prevent it from showing before popup
            if (hs) {
              hs.style.display = 'none';
            }
            document.body.classList.remove('home-visible');
            document.body.classList.add('game-over');
            gameStartedByUser = false;
            
            var controls = document.querySelector('.controls');
            if (controls) {
              controls.style.display = 'none';
              controls.style.visibility = 'hidden';
              controls.style.opacity = '0';
              controls.style.pointerEvents = 'none';
            }
            
            var closeBtn = document.getElementById('btnCloseGame');
            if (closeBtn) {
              closeBtn.style.display = 'none';
              closeBtn.style.visibility = 'hidden';
              closeBtn.style.opacity = '0';
            }
            
            updateButtonState('WAITING');
            
            // Banner display removed per user request
          });
          
          window.addEventListener('gamePlaying', function() {
            console.log('Pacman: Received gamePlaying event');
            
            if (typeof window.hideGameOverOverlay === 'function') {
              window.hideGameOverOverlay({hideHome: true});
            }
            
            // Don't show controls if home screen is visible (user clicked X to exit)
            if (document.body.classList.contains('home-visible')) {
              console.log('Pacman: Ignoring gamePlaying event - home screen is visible');
              return;
            }
            
            // Clear the home screen control check interval
            if (window.homeScreenControlCheck) {
              clearInterval(window.homeScreenControlCheck);
              window.homeScreenControlCheck = null;
            }
            
            // Mark that game has started (in case event fires before button click)
            gameStartedByUser = true;
            
            // Update button to show Pause (not Start) when game is playing
            updateButtonState('PLAYING');
            
            // Remove home-visible and game-over classes when game actually starts playing
            document.body.classList.remove('home-visible');
            document.body.classList.remove('game-over');
            // Add game-playing class to show controls
            document.body.classList.add('game-playing');
            
            // Show game wrapper and canvas - force display with !important via inline style
            var gameWrapper = document.querySelector('.game-wrapper');
            if (gameWrapper) {
              gameWrapper.style.display = 'flex';
              gameWrapper.style.setProperty('display', 'flex', 'important');
            }
            var pacman = document.getElementById('pacman');
            if (pacman) {
              pacman.style.display = 'block';
              pacman.style.setProperty('display', 'block', 'important');
            }
            
            // Make sure controls are visible when game starts
            var controls = document.querySelector('.controls');
            if (controls) {
              controls.style.display = 'block';
              controls.style.visibility = 'visible';
              controls.style.opacity = '1';
              controls.style.pointerEvents = 'auto';
              console.log('Pacman: Controls shown when game started');
            }
            
            // Show h1 and instructions when game starts
            var h1 = document.querySelector('h1');
            if (h1) {
              h1.style.display = '';
            }
            var instructions = document.getElementById('instructions');
            if (instructions) {
              instructions.style.display = '';
            }
            
            // Show close button - always visible during game
            var closeBtn = document.getElementById('btnCloseGame');
            if (closeBtn) {
              closeBtn.style.display = 'flex';
              closeBtn.style.visibility = 'visible';
              closeBtn.style.opacity = '1';
            }
            
            updateButtonState('PLAYING');
            
            // Periodic check to ensure canvas stays visible when game is playing
            // Clear any existing check
            if (window.canvasVisibilityCheck) {
              clearInterval(window.canvasVisibilityCheck);
            }
            
            // Start periodic check to keep canvas visible
            window.canvasVisibilityCheck = setInterval(function() {
              if (document.body.classList.contains('game-playing') && !document.body.classList.contains('home-visible')) {
                var gameWrapper = document.querySelector('.game-wrapper');
                if (gameWrapper && gameWrapper.style.display !== 'flex') {
                  gameWrapper.style.display = 'flex';
                }
                var pacman = document.getElementById('pacman');
                if (pacman && pacman.style.display !== 'block') {
                  pacman.style.display = 'block';
                }
              } else {
                // Clear interval if game is not playing
                if (window.canvasVisibilityCheck) {
                  clearInterval(window.canvasVisibilityCheck);
                  window.canvasVisibilityCheck = null;
                }
              }
            }, 200); // Check every 200ms
          });
          
          window.addEventListener('gamePaused', function() {
            console.log('Pacman: Received gamePaused event');
            updateButtonState('PAUSE');
          });
          
          // Set up button click handler with touch support
          setTimeout(function() {
            startPauseBtn = document.querySelector('.btn-start-pause');
            
            if (startPauseBtn) {
              // Function to handle button action
              function handleButtonAction(e) {
                if (e) {
                e.preventDefault();
                e.stopPropagation();
                }
                
                // Debounce check - reduce time to allow faster clicks
                if (isProcessingClick) {
                  console.log('Pacman: Button action ignored (debounce)');
                  return false;
                }
                
                if (startPauseBtn && startPauseBtn.disabled) {
                  console.log('Pacman: Button is disabled, ignoring action');
                  return false;
                }
                
                console.log('Pacman: Button action triggered, current state:', currentGameState);
                console.log('Pacman: Button element:', startPauseBtn);
                console.log('Pacman: Button innerHTML:', startPauseBtn ? startPauseBtn.innerHTML : 'N/A');
                console.log('Pacman: Button disabled:', startPauseBtn ? startPauseBtn.disabled : 'N/A');
                
                if (window.isNextLevelPromptVisible) {
                  console.log('Pacman: Button actions disabled while Next Level popup is visible');
                  return false;
                }

                var buttonTextPreview = startPauseBtn ? startPauseBtn.innerHTML.trim() : '';
                // Set debounce flag
                isProcessingClick = true;
                
                // Fire the appropriate key - use button text as primary check, state as fallback
                var keyCode = 0;
                var buttonText = buttonTextPreview;
                
                // Check button text first (more reliable)
                if (buttonText.includes('Start') || buttonText.includes('‚ñ∂ Start')) {
                  // Start the game - fire N key
                  keyCode = 78;
                  console.log('Pacman: Button shows Start, firing N key, keyCode:', keyCode);
                } else if (buttonText.includes('Pause') || buttonText.includes('‚è∏') || buttonText.includes('Resume') || buttonText.includes('‚ñ∂ Resume')) {
                  // Pause or Resume the game - fire P key (app.js handles based on actual state)
                  keyCode = 80;
                  console.log('Pacman: Button shows Pause/Resume, firing P key, keyCode:', keyCode, 'Button text:', buttonText);
                } else {
                  // Fallback to state-based logic
                  if (currentGameState === 'WAITING') {
                    keyCode = 78;
                    console.log('Pacman: Fallback - WAITING state, firing N key');
                  } else if (currentGameState === 'PLAYING' || currentGameState === 'COUNTDOWN' || currentGameState === 'PAUSE') {
                    keyCode = 80;
                    console.log('Pacman: Fallback - firing P key based on state:', currentGameState);
                  } else {
                    console.error('Pacman: Cannot determine action! Button text:', buttonText, 'State:', currentGameState);
                    isProcessingClick = false;
                    return false;
                  }
                }
                
                // Fire the key immediately - app.js will handle based on actual game state
                if (keyCode > 0) {
                  console.log('Pacman: About to call fireKey with keyCode:', keyCode);
                  try {
                    fireKey(keyCode);
                    console.log('Pacman: fireKey called successfully');
                  } catch(err) {
                    console.error('Pacman: Error calling fireKey:', err);
                    isProcessingClick = false;
                    return false;
                  }
                } else {
                  console.error('Pacman: No valid keyCode! Button text:', buttonText, 'State:', currentGameState);
                  isProcessingClick = false;
                  return false;
                }
                
                // Reset debounce after shorter delay
                  setTimeout(function() {
                    isProcessingClick = false;
                    console.log('Pacman: Debounce reset');
                }, 200);
                
                return true;
              }
              
              // Touch events (for mobile)
              var touchStartTime = 0;
              startPauseBtn.addEventListener('touchstart', function(e) {
                e.preventDefault();
                e.stopPropagation();
                touchStartTime = Date.now();
                // Haptic feedback
                if (navigator.vibrate) {
                  navigator.vibrate(10);
                }
              }, {passive: false});
              
              startPauseBtn.addEventListener('touchend', function(e) {
                e.preventDefault();
                e.stopPropagation();
                // Only fire if it was a quick tap (not a long press)
                var touchDuration = Date.now() - touchStartTime;
                if (touchDuration < 500 && touchDuration > 0) {
                  console.log('Pacman: Touch end detected, duration:', touchDuration);
                  handleButtonAction(e);
                }
              }, {passive: false});
              
              // Click event (for desktop/mouse) - use capture phase to ensure it fires
              startPauseBtn.addEventListener('click', function(e) {
                console.log('Pacman: Click event detected on start-pause button');
                handleButtonAction(e);
              }, true); // Use capture phase
            }
            
            // Initial state
            updateButtonState('WAITING');
            
            // Export for debugging
            window.pacmanButtonState = {
              getState: function() { return currentGameState; },
              setState: function(s) { updateButtonState(s); }
            };
          }, 100);
          
          // Close Game Button Handler - Return to home screen
          setTimeout(function() {
            var btnCloseGame = document.getElementById('btnCloseGame');
            if (btnCloseGame) {
              function handleCloseGame(e) {
                if (e) {
                  e.preventDefault();
                  e.stopPropagation();
                }
                
                console.log('Pacman: Close game button clicked - exitToMainMenu()');
                
                // Stop the game by dispatching stopGame event (this will reset game state to WAITING)
                try {
                  window.dispatchEvent(new CustomEvent('stopGame'));
                  console.log('Pacman: stopGame event dispatched');
                } catch(e) {
                  console.log('Pacman: Error dispatching stopGame event:', e);
                }
                
                if (typeof window.hideGameOverOverlay === 'function') {
                  window.hideGameOverOverlay();
                }
                if (typeof window.hideNextLevelPrompt === 'function') {
                  window.hideNextLevelPrompt();
                }
                
                // Stop/pause all audio when closing game
                try {
                  // Pause all audio elements on the page
                  var allAudio = document.querySelectorAll('audio');
                  for (var i = 0; i < allAudio.length; i++) {
                    if (allAudio[i]) {
                      allAudio[i].pause();
                      allAudio[i].currentTime = 0; // Reset to beginning
                    }
                  }
                  console.log('Pacman: All audio paused and reset when closing game');
                } catch(e) {
                  console.log('Pacman: Error stopping audio:', e);
                }
                
                // Clear canvas visibility check interval
                if (window.canvasVisibilityCheck) {
                  clearInterval(window.canvasVisibilityCheck);
                  window.canvasVisibilityCheck = null;
                }
                
                // Reset flag so gameWaiting can work on next start
                gameStartedByUser = false;
                
                // 1. Hide help modal (if open)
                var helpModal = document.getElementById('helpModal');
                if (helpModal) {
                  helpModal.style.display = 'none';
                }
                
                // 2. Reset game to ready state
                // Hide game, show home screen
                document.body.classList.remove('game-playing');
                document.body.classList.remove('game-over'); // Remove game-over class if present
                document.body.classList.add('home-visible');
                
                // Explicitly hide controls and all game UI elements
                var controls = document.querySelector('.controls');
                if (controls) {
                  controls.style.display = 'none';
                  controls.style.visibility = 'hidden';
                  controls.style.opacity = '0';
                  controls.style.pointerEvents = 'none';
                  // Force hide with !important via inline style
                  controls.style.setProperty('display', 'none', 'important');
                  controls.style.setProperty('visibility', 'hidden', 'important');
                }
                
                // Hide close button only when returning to home screen
                var closeBtn = document.getElementById('btnCloseGame');
                if (closeBtn) {
                  closeBtn.style.display = 'none';
                  closeBtn.style.visibility = 'hidden';
                  closeBtn.style.opacity = '0';
                }
                
                // Hide h1 and instructions (game UI elements)
                var h1 = document.querySelector('h1');
                if (h1) {
                  h1.style.display = 'none';
                }
                var instructions = document.getElementById('instructions');
                if (instructions) {
                  instructions.style.display = 'none';
                }
                
                // Show home screen
                var home = document.getElementById('home');
                if (home) {
                  home.style.display = 'flex';
                }
                
                // Banner display removed per user request
                
                // Hide game wrapper
                var gameWrapper = document.querySelector('.game-wrapper');
                if (gameWrapper) {
                  gameWrapper.style.display = 'none';
                }
                
                // Hide game canvas
                var pacman = document.getElementById('pacman');
                if (pacman) {
                  pacman.style.display = 'none';
                }
                
                // Update button state to waiting
                if (typeof updateButtonState === 'function') {
                  updateButtonState('WAITING');
                }
                
                // Fire gameWaiting event to sync state
                try {
                  window.dispatchEvent(new CustomEvent('gameWaiting'));
                } catch(e) {
                  console.log('Error dispatching gameWaiting:', e);
                }
                
                // Show interstitial ad before returning to home (gotoHome flow) - no caching
                try {
                  if (typeof showAd === 'function' && window.isAdReady === true) {
                    console.log('Pacman: Showing interstitial ad before returning to home (if available)');
                    // Set flag to prevent game caching when ad closes
                    window.skipGameCachingOnAdClose = true;
                    showAd();
                  } else {
                    console.log('Pacman: Ad not available, skipping ad show on X click');
                  }
                } catch(e) {
                  console.log('Error showing ad:', e);
                }
                
                // 5. Set up periodic check to ensure controls stay hidden on home screen
                // Clear any existing interval
                if (window.homeScreenControlCheck) {
                  clearInterval(window.homeScreenControlCheck);
                }
                
                // Check every 500ms to ensure controls are hidden when home-visible
                window.homeScreenControlCheck = setInterval(function() {
                  if (document.body.classList.contains('home-visible')) {
                    var controls = document.querySelector('.controls');
                    if (controls) {
                      // Aggressively hide controls with !important
                      controls.style.setProperty('display', 'none', 'important');
                      controls.style.setProperty('visibility', 'hidden', 'important');
                      controls.style.setProperty('opacity', '0', 'important');
                      controls.style.setProperty('pointer-events', 'none', 'important');
                    }
                    
                    // Close button should only be hidden on home screen (handled by CSS)
                    // Don't hide it here as it should be visible during game
                    
                    var h1 = document.querySelector('h1');
                    if (h1 && h1.style.display !== 'none') {
                      h1.style.display = 'none';
                    }
                    
                    var instructions = document.getElementById('instructions');
                    if (instructions && instructions.style.display !== 'none') {
                      instructions.style.display = 'none';
                    }
                  } else {
                    // Home screen not visible, clear the check
                    if (window.homeScreenControlCheck) {
                      clearInterval(window.homeScreenControlCheck);
                      window.homeScreenControlCheck = null;
                    }
                  }
                }, 500);
              }
              
              // Touch support
              btnCloseGame.addEventListener('touchstart', function(e) {
                e.preventDefault();
                handleCloseGame(e);
              }, {passive: false});
              
              // Click support
              btnCloseGame.addEventListener('click', function(e) {
                handleCloseGame(e);
              });
            }
          }, 150);
        });
      })();
    </script>
  </body>
</html>


