<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="theme-color" content="#000000" />
    <meta name="application-name" content="Pacman Game" />
    <meta name="description" content="Classic Pacman game for KaiOS and JioPhone devices" />
    
    <title>Pacman - JioPhone</title>
    
    <!-- App Icons for KaiOS -->
    <link rel="icon" type="image/png" sizes="56x56" href="./icons/icon-56.png" />
    <link rel="icon" type="image/png" sizes="112x112" href="./icons/icon-112.png" />
    <link rel="shortcut icon" href="./icons/icon-56.png" />
    <link rel="apple-touch-icon" sizes="112x112" href="./icons/icon-112.png" />
    
    <!-- KaiOS Manifest -->
    <link rel="manifest" href="./manifest.webapp" />
    
    <link rel="stylesheet" href="style.css" />
  </head>
  <body>
    <!-- Splash Screen -->
    <div id="splash-screen">
      <div class="splash-content">
        <div class="pacman-loader">
          <div class="pacman-mouth"></div>
        </div>
        <h2 class="splash-title">PACMAN</h2>
        <div class="loading-dots">
          <span>.</span><span>.</span><span>.</span>
        </div>
        <p class="splash-text">Loading Game...</p>
      </div>
    </div>

    <!-- Home Screen -->
    <div id="home-screen" class="home-screen">
      <div class="home-content">
        <div class="game-logo">üéÆ</div>
        <h1 class="game-title-large">Pacman</h1>
        <button id="start-btn" class="start-button">START GAME</button>
        <div class="how-to-play">
          <h3>How to Play</h3>
          <div class="controls-layout">
            <div class="control-row">
              <div class="control-item">
                <span class="key-badge">8</span>
                <span class="control-text">Up</span>
              </div>
              <div class="control-item">
                <span class="key-badge">2</span>
                <span class="control-text">Down</span>
              </div>
            </div>
            <div class="control-item-center">
              <span class="key-badge">5</span>
              <span class="control-text">Start</span>
            </div>
            <div class="control-row">
              <div class="control-item">
                <span class="key-badge">4</span>
                <span class="control-text">Left</span>
              </div>
              <div class="control-item">
                <span class="key-badge">6</span>
                <span class="control-text">Right</span>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Game Wrapper -->
    <div class="game-wrapper" id="game-wrapper" style="display: none;">
      <div id="pacman" aria-label="Pacman Game"></div>
      <button id="game-home-btn" class="game-home-button">Home</button>
    </div>

    <!-- Rewarded Video Confirmation Dialog -->
    <div id="rewarded-dialog" class="rewarded-dialog" role="dialog" aria-hidden="true" aria-modal="true" aria-labelledby="rewarded-dialog-title">
      <div class="rewarded-dialog-content">
        <h2 id="rewarded-dialog-title">Watch Ad for Extra Life?</h2>
        <p class="rewarded-dialog-text">Watch a rewarded video ad to get +1 Nitro and continue playing.</p>
        <div class="rewarded-buttons" role="group" aria-label="Rewarded Ad Choices">
          <button class="rewarded-btn skip-btn" data-action="skip" aria-pressed="false">‚¨ÜÔ∏è Skip</button>
          <button class="rewarded-btn watch-btn selected" data-action="watch" aria-pressed="true">‚¨áÔ∏è Watch Ad</button>
        </div>
        <div class="rewarded-hints">
          <span>Use 8/2 or arrows to move</span>
          <span>4/6 to switch ‚Ä¢ 5/Enter to confirm</span>
          <span>Back key = Skip</span>
        </div>
      </div>
    </div>

    <!-- Toast Notification -->
    <div id="exit-toast" class="exit-toast" aria-live="polite" aria-atomic="true">
      <span class="toast-text">Double click instantly for exit game</span>
    </div>

    <!-- JioGames SDK (Load First) -->
    <script src="./jiogames_jp.js" type="text/javascript"></script>
    <script>
        // Console logging for Jio Phone SDK
        console.log("Pacman - Jio Phone SDK initialized");
        window.addEventListener('load', function() {
            console.log("Pacman Jio Phone - Page Loaded");
            
            // JioGames SDK Integration - Get user profile on game load
            setTimeout(function() {
                if (typeof getUserProfile === 'function') {
                    getUserProfile();
                    console.log("Pacman FP: User profile requested");
                }
                
                // Note: Ads will be cached when user clicks "Start Game"
                console.log("Pacman FP: Ads will be cached on game start");
            }, 1000);
        });
    </script>
    
    <!-- Feature Detection (Modernizr-lite fallback) -->
    <script>
      (function() {
        window.Modernizr = window.Modernizr || {};

        if (typeof Modernizr.canvas === 'undefined') {
          var canvasEl = document.createElement('canvas');
          Modernizr.canvas = !!(canvasEl.getContext && canvasEl.getContext('2d'));
        }

        if (typeof Modernizr.localstorage === 'undefined') {
          try {
            var testKey = '__modernizr_ls__';
            localStorage.setItem(testKey, testKey);
            localStorage.removeItem(testKey);
            Modernizr.localstorage = true;
          } catch (e) {
            Modernizr.localstorage = false;
          }
        }

        if (typeof Modernizr.audio === 'undefined') {
          Modernizr.audio = {};
        }

        var audioEl = document.createElement('audio');
        var canPlayType = audioEl && audioEl.canPlayType ? audioEl.canPlayType.bind(audioEl) : null;

        if (typeof Modernizr.audio.ogg === 'undefined') {
          Modernizr.audio.ogg = !!(canPlayType && canPlayType('audio/ogg; codecs="vorbis"').replace(/no/, ''));
        }

        if (typeof Modernizr.audio.mp3 === 'undefined') {
          Modernizr.audio.mp3 = !!(canPlayType && canPlayType('audio/mpeg;').replace(/no/, ''));
        }
      })();
    </script>
    
    <!-- Home Screen Controller -->
    <script>
      (function() {
        console.log("=== Home Screen: Initializing ===");
        
        var homeScreen = document.getElementById('home-screen');
        var gameWrapper = document.getElementById('game-wrapper');
        var startButton = document.getElementById('start-btn');
        window.gameStarted = window.gameStarted || false;
        window.pacmanInitialized = window.pacmanInitialized || false;
        
        function startGame() {
          if (window.gameStarted) return;
          window.gameStarted = true;
          console.log("=== Home Screen: Starting Game ===");
          homeScreen.style.display = 'none';
          gameWrapper.style.display = 'flex';
          
          // Set up game home button
          var gameHomeBtn = document.getElementById('game-home-btn');
          if (gameHomeBtn) {
            gameHomeBtn.addEventListener('click', function(e) {
              e.preventDefault();
              e.stopPropagation();
              console.log("Game home button clicked");
              if (typeof PACMAN !== 'undefined' && typeof PACMAN.goToHomeScreen === 'function') {
                // Show ad before going home (during gameplay)
                PACMAN.goToHomeScreen(true);
              } else {
                // Fallback
                var gameWrapper = document.getElementById('game-wrapper');
                var homeScreen = document.getElementById('home-screen');
                if (gameWrapper) gameWrapper.style.display = 'none';
                if (homeScreen) homeScreen.style.display = 'flex';
                window.gameStarted = false;
              }
            });
          }
          
          // Initialize game after showing game wrapper
          setTimeout(function() {
            var el = document.getElementById("pacman");
            if (Modernizr.canvas && Modernizr.localstorage) {
              if (!window.pacmanInitialized) {
                console.log("Starting PACMAN.init() from home screen...");
                if (el) {
                  el.innerHTML = "";
                }
                PACMAN.init(el, "./audio/");
                window.pacmanInitialized = true;
              } else {
                console.log("PACMAN already initialized - reusing existing canvas");
                if (el && el.children.length > 1) {
                  while (el.children.length > 1) {
                    el.removeChild(el.lastChild);
                  }
                }
              }

              var shouldResume = typeof PACMAN !== 'undefined' &&
                                 typeof PACMAN.canResumeFromHome === 'function' &&
                                 PACMAN.canResumeFromHome();

              // Wait for game to be ready, then resume or start
              setTimeout(function() {
                if (shouldResume && typeof PACMAN.resumeFromHome === 'function') {
                  console.log("Resuming paused game from home screen...");
                  PACMAN.resumeFromHome();
                } else if (typeof PACMAN.startNewGame === 'function') {
                  console.log("Starting new game from home screen...");
                  PACMAN.startNewGame();
                }
              }, 500);
            }
          }, 100);
        }
        
        // Handle button click
        if (startButton) {
          startButton.addEventListener('click', startGame);
        }
        
        // Handle key press on home screen
        function handleHomeKeyPress(e) {
          // Only handle if home screen is visible
          if (homeScreen && homeScreen.style.display !== 'none') {
            var keyCode = e.keyCode || e.which;
            
            // Back button (ESC = 27) - handle double press on home screen
            if (keyCode === 27 || e.key === 'Backspace' || e.key === 'Escape') {
              e.preventDefault();
              e.stopPropagation();
              
              var currentTime = Date.now();
              var timeSinceLastPress = currentTime - (window.lastHomeBackPress || 0);
              
              if (timeSinceLastPress < 600 && window.lastHomeBackPress > 0) {
                // Double press - exit game
                console.log("Back button double press on home screen - exiting");
                window.lastHomeBackPress = 0;
                if (typeof PACMAN !== 'undefined' && PACMAN.hideToast) {
                  PACMAN.hideToast();
                }
                if (typeof PACMAN !== 'undefined' && PACMAN.exitGame) {
                  PACMAN.exitGame();
                } else {
                  window.history.back();
                }
                return false;
              } else {
                // Single press - show toast
                console.log("Back button single press on home screen - showing toast");
                window.lastHomeBackPress = currentTime;
                if (typeof PACMAN !== 'undefined' && PACMAN.showToast) {
                  PACMAN.showToast();
                }
                return false;
              }
            }
            
            // 5 key (numeric keypad or regular), Enter key, or OK button
            // Key codes: 53 = '5', 101 = numpad '5', 13 = Enter
            if (keyCode === 53 || keyCode === 101 || keyCode === 13) {
              e.preventDefault();
              e.stopPropagation();
              window.lastHomeBackPress = 0; // Reset back press timer
              startGame();
              return false;
            }
            
            // Reset back press timer if other key is pressed
            if (keyCode !== 27) {
              window.lastHomeBackPress = 0;
            }
          }
        }
        
        // Wait for DOM to be ready, then listen for key events
        if (document.readyState === 'loading') {
          document.addEventListener('DOMContentLoaded', function() {
            document.addEventListener('keydown', handleHomeKeyPress, true);
            document.addEventListener('keypress', handleHomeKeyPress, true);
          });
        } else {
          document.addEventListener('keydown', handleHomeKeyPress, true);
          document.addEventListener('keypress', handleHomeKeyPress, true);
        }
        
        console.log("=== Home Screen: Ready ===");
      })();
    </script>
    
    <!-- Game Logic -->
    <script src="./app.js" type="text/javascript"></script>

    <!-- Feature Phone Controls Script (KaiOS/JioPhone) -->
    <script>
      console.log("=== Initializing Feature Phone Controls ===");
      
      (function() {
        // Map numpad keys to arrow keys for feature phones
        var keyMapping = {
          50: 38,  // 2 -> UP
          56: 40,  // 8 -> DOWN
          52: 37,  // 4 -> LEFT
          54: 39,  // 6 -> RIGHT
          53: 78,  // 5 -> N (Start)
          106: 83  // * -> S (Sound)
        };

        // Also handle KaiOS/JioPhone specific keycodes
        var kaiosMapping = {
          'ArrowUp': 38,
          'ArrowDown': 40,
          'ArrowLeft': 37,
          'ArrowRight': 39,
          'Enter': 78,  // Center softkey = Start
          'SoftLeft': 83, // Left softkey = Sound
          'SoftRight': 27, // Right softkey = Home screen (ESC code)
          '*': 83
        };

        console.log("Key mappings configured:", keyMapping);
        console.log("KaiOS mappings configured:", kaiosMapping);

        function handleKeyPress(e) {
          var keyCode = e.keyCode || e.which;
          var key = e.key;
          
          if (window.rewardedDialogActive) {
            return;
          }
          
          console.log("Key pressed - Code:", keyCode, "Key:", key);

          // Handle SoftRight key - go to home screen directly
          if (key === 'SoftRight' || (key && key.toLowerCase() === 'softright')) {
            console.log("SoftRight key detected - going to home screen");
            e.preventDefault();
            e.stopPropagation();
            // Check if game is running and call goToHomeScreen
            if (typeof PACMAN !== 'undefined' && PACMAN.goToHomeScreen) {
              PACMAN.goToHomeScreen();
            } else {
              // Fallback: hide game wrapper and show home screen
              var gameWrapper = document.getElementById('game-wrapper');
              var homeScreen = document.getElementById('home-screen');
              if (gameWrapper) gameWrapper.style.display = 'none';
              if (homeScreen) homeScreen.style.display = 'flex';
            }
            return false;
          }

          // Handle numeric keypad
          if (keyMapping[keyCode]) {
            var mappedCode = keyMapping[keyCode];
            console.log("Mapping key", keyCode, "to", mappedCode);
            fireKey(mappedCode);
            e.preventDefault();
            return false;
          }

          // Handle KaiOS keys
          if (kaiosMapping[key]) {
            console.log("KaiOS key detected:", key);
            fireKey(kaiosMapping[key]);
            e.preventDefault();
            return false;
          }
        }

        function fireKey(code) {
          console.log("Firing keyboard event with code:", code);
          try {
            var ev = new KeyboardEvent('keydown', {
              bubbles: true, 
              cancelable: true, 
              keyCode: code, 
              which: code
            });
            document.dispatchEvent(ev);
            console.log("Event dispatched successfully");
          } catch (e) {
            console.log("Using fallback event method");
            // Fallback for older feature phones
            var ev = document.createEvent('Event');
            ev.initEvent('keydown', true, true);
            ev.keyCode = code;
            ev.which = code;
            document.dispatchEvent(ev);
          }
        }

        // Listen for all key events
        document.addEventListener('keydown', handleKeyPress, true);
        document.addEventListener('keypress', handleKeyPress, true);
        console.log("Event listeners attached");

        // Prevent default scrolling on arrow keys
        window.addEventListener('keydown', function(e) {
          if([37, 38, 39, 40].indexOf(e.keyCode) > -1) {
            e.preventDefault();
            console.log("Prevented default scroll for arrow key");
          }
        }, false);
        
        console.log("=== Feature Phone Controls Initialized ===");
      })();
    </script>
    
    <!-- JioGames Integration Test -->
    <script>
      console.log("=== Testing JioGames Integration ===");
      
      // Test SDK availability
      setTimeout(function() {
        console.log("Testing SDK functions availability:");
        console.log("- cacheAd:", typeof cacheAd);
        console.log("- showAd:", typeof showAd);
        console.log("- postScore:", typeof postScore);
        console.log("- getUserProfile:", typeof getUserProfile);
        
        // Log game initialization
        console.log("Game starting in feature phone mode");
        console.log("Package:", package);
      }, 1000);
    </script>

    <!-- Splash Screen Controller -->
    <script>
      (function() {
        console.log("=== Splash Screen: Initializing ===");
        
        var splashScreen = document.getElementById('splash-screen');
        var minDisplayTime = 2000; // Minimum 2 seconds
        var startTime = Date.now();
        
        // Hide splash when everything is loaded
        function hideSplash() {
          var elapsedTime = Date.now() - startTime;
          var remainingTime = Math.max(0, minDisplayTime - elapsedTime);
          
          console.log("Splash Screen: Elapsed time:", elapsedTime + "ms");
          console.log("Splash Screen: Remaining time:", remainingTime + "ms");
          
          setTimeout(function() {
            console.log("=== Splash Screen: Hiding ===");
            splashScreen.style.opacity = '0';
            
            setTimeout(function() {
              splashScreen.style.display = 'none';
              console.log("=== Splash Screen: Hidden ===");
            }, 500); // Fade out duration
          }, remainingTime);
        }
        
        // Hide splash after game initialization
        window.addEventListener('load', function() {
          console.log("Splash Screen: Window loaded");
          // Wait for game to initialize
          setTimeout(hideSplash, 500);
        });
        
        // Fallback: hide after max 5 seconds
        setTimeout(function() {
          console.log("Splash Screen: Fallback timeout - hiding");
          hideSplash();
        }, 5000);
        
      })();
    </script>
  </body>
</html>

